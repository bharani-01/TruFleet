<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TruFleet | Identity Management</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Manrope:wght@500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <script src="trufleet-theme.js"></script>
    <script src="trufleet-api.js"></script>
    <script src="trufleet-notif.js"></script>
    <script src="auth-check.js"></script>
    <script src="rbac.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        :root {
            --bg-body:      #F8FAFC;
            --bg-surface:   #FFFFFF;
            --bg-sidebar:   #0F172A;
            --bg-muted:     #F1F5F9;
            --text-primary: #0F172A;
            --text-secondary:#64748B;
            --text-tertiary: #94A3B8;
            --border:       #E2E8F0;
            --border-mid:   #CBD5E1;
            --accent-blue:  #3B82F6;
            --accent-green: #10B981;
            --accent-amber: #F59E0B;
            --accent-red:   #EF4444;
            --accent-purple:#8B5CF6;
            --sidebar-w:    72px;
            --sidebar-exp:  260px;
            --header-h:     70px;
            --shadow-card:  0 1px 3px 0 rgba(0,0,0,.07), 0 1px 2px -1px rgba(0,0,0,.05);
            --shadow-float: 0 20px 25px -5px rgba(0,0,0,.06), 0 10px 10px -5px rgba(0,0,0,.02);
            --shadow-drawer: -10px 0 40px rgba(0,0,0,.08);
            --radius-lg:    16px;
            --radius-md:    12px;
            --radius-sm:    8px;
            --ease:         cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin:0; padding:0; box-sizing:border-box; outline:none; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-body);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* ── Sidebar ── */
        .sidebar {
            width: var(--sidebar-w);
            background: var(--bg-sidebar);
            height: 100vh;
            position: fixed;
            left: 0; top: 0;
            display: flex; flex-direction: column;
            transition: width .3s var(--ease);
            z-index: 200;
            overflow: hidden;
        }
        .sidebar:hover { width: var(--sidebar-exp); }
        .brand-icon {
            padding: 1.25rem 0;
            display: flex; align-items: center; justify-content: center;
            gap: .75rem; font-size: 1.4rem; color: var(--accent-blue);
            min-height: var(--header-h); overflow: hidden;
        }
        .brand-text {
            font-family: 'Manrope', sans-serif; font-weight: 800; font-size: 1rem;
            color: white; white-space: nowrap; opacity: 0;
            transition: opacity .2s var(--ease) .05s;
        }
        .sidebar:hover .brand-text { opacity: 1; }
        .nav-menu { display: flex; flex-direction: column; flex: 1; padding: .5rem 0; gap: 2px; }
        .nav-item {
            display: flex; align-items: center; gap: 1rem;
            padding: .875rem 1.35rem;
            color: #94A3B8; font-size: .875rem; font-weight: 500;
            text-decoration: none; border-radius: 0;
            transition: all .2s var(--ease); white-space: nowrap;
        }
        .nav-item:hover { background: rgba(255,255,255,.07); color: white; }
        .nav-item.active { background: rgba(59,130,246,.15); color: var(--accent-blue); border-right: 3px solid var(--accent-blue); }
        .nav-item i { font-size: 1.25rem; flex-shrink: 0; }
        .nav-label { opacity: 0; transition: opacity .15s var(--ease); white-space: nowrap; }
        .sidebar:hover .nav-label { opacity: 1; }

        /* ── Main layout ── */
        .main-wrapper {
            margin-left: var(--sidebar-w); flex: 1;
            display: flex; flex-direction: column;
            height: 100vh; overflow-y: auto;
        }

        /* ── Header ── */
        header {
            height: var(--header-h);
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 2rem;
            position: sticky; top: 0; z-index: 100;
            box-shadow: var(--shadow-card);
        }
        .header-title h1 {
            font-family: 'Manrope', sans-serif; font-size: 1.25rem; font-weight: 700;
            display: flex; align-items: center; gap: 10px;
        }
        .header-title h1 i { color: var(--accent-blue); }
        .header-title span { color: var(--text-secondary); font-size: .9rem; font-weight: 400; }
        .header-actions { display: flex; align-items: center; gap: 1rem; }
        .avatar {
            width: 36px; height: 36px; border-radius: 50%;
            background: var(--bg-sidebar); color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: .9rem; font-weight: 600;
        }

        /* ── Page body ── */
        .page-content { padding: 2rem; max-width: 1400px; margin: 0 auto; width: 100%; }

        /* ── KPI strip ── */
        .kpi-strip { display: grid; grid-template-columns: repeat(6, 1fr); gap: 1rem; margin-bottom: 1.75rem; }
        .kpi-card {
            background: var(--bg-surface); border: 1px solid var(--border);
            border-radius: var(--radius-md); padding: 1.1rem 1.25rem;
            box-shadow: var(--shadow-card);
        }
        .kpi-label { font-size: .72rem; font-weight: 600; text-transform: uppercase; letter-spacing: .06em; color: var(--text-tertiary); margin-bottom: .4rem; }
        .kpi-value { font-family: 'Manrope', sans-serif; font-size: 1.75rem; font-weight: 800; line-height: 1; }
        .kpi-value.green  { color: var(--accent-green); }
        .kpi-value.red    { color: var(--accent-red); }
        .kpi-value.amber  { color: var(--accent-amber); }
        .kpi-value.blue   { color: var(--accent-blue); }

        /* ── Tab bar ── */
        .tab-bar {
            display: flex; gap: 4px; margin-bottom: 1.5rem;
            background: var(--bg-surface); border: 1px solid var(--border);
            padding: 5px; border-radius: 10px; width: fit-content;
            box-shadow: var(--shadow-card);
        }
        .tab-btn {
            padding: 8px 20px; border: none; background: transparent;
            color: var(--text-secondary); font-size: .875rem; font-weight: 500;
            border-radius: 7px; cursor: pointer;
            display: flex; align-items: center; gap: 7px;
            transition: background .15s, color .15s; font-family: 'Inter', sans-serif;
        }
        .tab-btn.active { background: var(--bg-sidebar); color: white; }
        .tab-btn:not(.active):hover { background: var(--bg-muted); color: var(--text-primary); }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* ── Cards ── */
        .card {
            background: var(--bg-surface); border: 1px solid var(--border);
            border-radius: var(--radius-md); padding: 1.5rem;
            box-shadow: var(--shadow-card);
        }
        .card-title {
            font-family: 'Manrope', sans-serif; font-weight: 700; font-size: .95rem;
            margin-bottom: 1rem; display: flex; align-items: center; gap: 8px;
        }
        .card-title i { color: var(--accent-blue); }

        /* ── Verify layout ── */
        .verify-layout { display: grid; grid-template-columns: 400px 1fr; gap: 1.5rem; }
        .search-row { display: flex; gap: 0; margin-bottom: 1rem; }
        .search-row input {
            flex: 1; height: 44px; background: var(--bg-muted); border: 1px solid var(--border-mid);
            border-right: none; border-radius: var(--radius-sm) 0 0 var(--radius-sm);
            padding: 0 1rem; color: var(--text-primary); font-size: .9rem;
            font-family: 'Inter', sans-serif; text-transform: uppercase;
            transition: border-color .2s;
        }
        .search-row input::placeholder { text-transform: none; color: var(--text-tertiary); }
        .search-row input:focus { border-color: var(--accent-blue); background: white; }
        .btn-verify {
            height: 44px; padding: 0 18px; background: var(--bg-sidebar);
            border: none; border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
            color: white; font-size: .875rem; font-weight: 600;
            cursor: pointer; display: flex; align-items: center; gap: 7px;
            transition: background .15s; white-space: nowrap;
        }
        .btn-verify:hover  { background: #1E293B; }
        .btn-verify.loading { opacity: .65; pointer-events: none; }

        /* Check chain */
        .chain-box { display: flex; flex-direction: column; gap: 6px; }
        .check-item {
            display: flex; align-items: center; gap: 10px;
            padding: 9px 12px; border-radius: var(--radius-sm);
            border: 1px solid var(--border); background: var(--bg-muted);
            transition: border-color .25s, background .25s;
        }
        .check-item.pass  { border-color: #A7F3D0; background: #F0FDF4; }
        .check-item.fail  { border-color: #FECACA; background: #FEF2F2; }
        .check-item.warn  { border-color: #FDE68A; background: #FFFBEB; }
        .check-item.skip  { opacity: .5; }
        .check-icon {
            width: 26px; height: 26px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; font-size: .85rem;
        }
        .check-item.idle .check-icon    { background: #E2E8F0; color: #94A3B8; }
        .check-item.pending .check-icon { background: #DBEAFE; color: var(--accent-blue); }
        .check-item.pass .check-icon    { background: #D1FAE5; color: var(--accent-green); }
        .check-item.fail .check-icon    { background: #FEE2E2; color: var(--accent-red); }
        .check-item.warn .check-icon    { background: #FEF3C7; color: var(--accent-amber); }
        .check-item.skip .check-icon    { background: #E2E8F0; color: #94A3B8; }
        .check-info .check-title  { font-size: .82rem; font-weight: 600; color: var(--text-primary); }
        .check-info .check-note   { font-size: .75rem; color: var(--text-secondary); margin-top: 1px; }

        /* Identity result card */
        .id-card {
            background: var(--bg-surface); border: 1px solid var(--border);
            border-radius: var(--radius-md); overflow: hidden;
            box-shadow: var(--shadow-float); display: none;
        }
        .id-card.visible { display: block; }
        .id-card-banner {
            padding: 1.25rem 1.5rem;
            display: flex; align-items: center; justify-content: space-between;
        }
        .id-card-banner.auth   { background: linear-gradient(135deg, #F0FDF4 0%, #DCFCE7 100%); border-bottom: 1px solid #A7F3D0; }
        .id-card-banner.denied { background: linear-gradient(135deg, #FEF2F2 0%, #FEE2E2 100%); border-bottom: 1px solid #FECACA; }
        .verdict {
            font-family: 'Manrope', sans-serif; font-size: 1.3rem; font-weight: 800;
            display: flex; align-items: center; gap: 8px;
        }
        .verdict.auth   { color: #065F46; }
        .verdict.denied { color: #991B1B; }
        .denial-reason {
            font-size: .8rem; color: #991B1B; background: #FEE2E2;
            padding: 5px 12px; border-radius: 6px; margin-top: 6px;
        }
        .id-sections { display: grid; grid-template-columns: repeat(3, 1fr); }
        .id-section {
            padding: 1.25rem 1.5rem; border-right: 1px solid var(--border);
        }
        .id-section:last-child { border-right: none; }
        .id-section-title {
            font-size: .7rem; font-weight: 700; text-transform: uppercase;
            letter-spacing: .07em; color: var(--text-tertiary);
            margin-bottom: .75rem; display: flex; align-items: center; gap: 5px;
        }
        .id-section-title i { color: var(--accent-blue); }
        .id-field { margin-bottom: .6rem; }
        .id-field .lbl { font-size: .72rem; color: var(--text-secondary); margin-bottom: 2px; }
        .id-field .val { font-size: .875rem; font-weight: 600; font-family: 'JetBrains Mono', monospace; }
        .id-field .val.normal { font-family: 'Inter', sans-serif; }
        .empty-placeholder {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 10px; padding: 3rem; color: var(--text-tertiary); text-align: center;
        }
        .empty-placeholder i { font-size: 2.5rem; opacity: .4; }
        .empty-placeholder p { font-size: .875rem; line-height: 1.5; }

        /* Status / risk badges */
        .kyc-badge, .status-badge, .risk-badge, .tag {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 2px 9px; border-radius: 20px; font-size: .72rem; font-weight: 600;
        }
        .kyc-badge.verified, .tag.active    { background: #D1FAE5; color: #065F46; }
        .kyc-badge.pending                  { background: #FEF3C7; color: #92400E; }
        .kyc-badge.rejected, .tag.expired   { background: #FEE2E2; color: #991B1B; }
        .status-badge.active                { background: #D1FAE5; color: #065F46; }
        .status-badge.blocked               { background: #FEE2E2; color: #991B1B; }
        .risk-badge.safe                    { background: #D1FAE5; color: #065F46; }
        .risk-badge.warning                 { background: #FEF3C7; color: #92400E; }
        .risk-badge.critical, .risk-badge.expired { background: #FEE2E2; color: #991B1B; }
        .tag.suspended                      { background: #FEF3C7; color: #92400E; }
        .tag.cancelled, .tag.superseded     { background: #F1F5F9; color: #64748B; }

        /* ── Owners tab ── */
        .toolbar {
            display: flex; align-items: center; gap: .75rem;
            margin-bottom: 1.25rem; flex-wrap: wrap;
        }
        .search-wrap { position: relative; }
        .search-wrap i {
            position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
            color: var(--text-tertiary); font-size: .9rem; pointer-events: none;
        }
        .search-input {
            height: 38px; background: var(--bg-surface); border: 1px solid var(--border);
            border-radius: var(--radius-sm); padding: 0 12px 0 34px;
            color: var(--text-primary); font-size: .875rem; font-family: 'Inter', sans-serif;
            width: 240px; transition: border-color .2s, box-shadow .2s;
        }
        .search-input:focus { border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(59,130,246,.1); }
        .filter-btn {
            height: 38px; padding: 0 14px; background: var(--bg-surface);
            border: 1px solid var(--border); border-radius: var(--radius-sm);
            color: var(--text-secondary); font-size: .8rem; font-weight: 500;
            cursor: pointer; transition: all .15s; font-family: 'Inter', sans-serif;
        }
        .filter-btn:hover { background: var(--bg-muted); color: var(--text-primary); }
        .filter-btn.active { background: var(--bg-sidebar); color: white; border-color: var(--bg-sidebar); }
        .btn-primary {
            height: 38px; padding: 0 16px; background: var(--bg-sidebar);
            border: none; border-radius: 100px; color: white;
            font-size: .875rem; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; gap: 7px;
            transition: all .2s; font-family: 'Inter', sans-serif;
            box-shadow: 0 4px 12px rgba(15,23,42,.15);
        }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(15,23,42,.2); }

        .owners-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
        .owner-card {
            background: var(--bg-surface); border: 1px solid var(--border);
            border-radius: var(--radius-md); padding: 1.25rem;
            cursor: pointer; box-shadow: var(--shadow-card);
            transition: border-color .2s, box-shadow .2s, transform .15s;
        }
        .owner-card:hover { border-color: var(--accent-blue); box-shadow: var(--shadow-float); transform: translateY(-2px); }
        .owner-top { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .owner-avatar {
            width: 42px; height: 42px; border-radius: 50%; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Manrope', sans-serif; font-size: .95rem; font-weight: 800; color: white;
        }
        .owner-name { font-weight: 600; font-size: .9rem; margin-bottom: 2px; }
        .owner-sub  { font-size: .78rem; color: var(--text-secondary); }
        .owner-meta { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .owner-meta-item { font-size: .78rem; color: var(--text-secondary); display: flex; align-items: center; gap: 5px; }
        .owner-meta-item i { font-size: .8rem; color: var(--text-tertiary); }
        .owner-footer {
            display: flex; align-items: center; justify-content: space-between;
            margin-top: 12px; padding-top: 10px; border-top: 1px solid var(--border);
        }

        /* ── Policy table ── */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: .875rem; }
        th {
            text-align: left; padding: 10px 14px;
            font-size: .72rem; font-weight: 700; text-transform: uppercase;
            letter-spacing: .06em; color: var(--text-tertiary);
            background: var(--bg-muted); border-bottom: 1px solid var(--border);
        }
        td { padding: 11px 14px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: var(--bg-muted); }
        .mono { font-family: 'JetBrains Mono', monospace; font-size: .82rem; }
        .loading-row td { text-align: center; padding: 2.5rem; color: var(--text-tertiary); }

        /* ── Modals ── */
        .overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(15,23,42,.5); z-index: 300;
            align-items: center; justify-content: center;
        }
        .overlay.open { display: flex; }
        .modal {
            background: var(--bg-surface); border: 1px solid var(--border);
            border-radius: var(--radius-lg); padding: 2rem;
            width: 560px; max-height: 90vh; overflow-y: auto;
            box-shadow: 0 25px 60px rgba(0,0,0,.15);
        }
        .modal-title {
            font-family: 'Manrope', sans-serif; font-weight: 700; font-size: 1.1rem;
            margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: space-between;
        }
        .modal-close { background: none; border: none; color: var(--text-tertiary); cursor: pointer; font-size: 1.25rem; padding: 2px; }
        .modal-close:hover { color: var(--text-primary); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: .875rem; }
        .form-group { display: flex; flex-direction: column; gap: .3rem; }
        .form-group.full { grid-column: 1 / -1; }
        .form-group label { font-size: .78rem; font-weight: 600; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea {
            height: 38px; background: var(--bg-muted); border: 1px solid var(--border);
            border-radius: var(--radius-sm); padding: 0 12px;
            color: var(--text-primary); font-size: .875rem; font-family: 'Inter', sans-serif;
            transition: border-color .2s, box-shadow .2s;
        }
        .form-group textarea { height: 72px; padding: 9px 12px; resize: vertical; }
        .form-group input:focus, .form-group select:focus {
            border-color: var(--accent-blue); background: white;
            box-shadow: 0 0 0 3px rgba(59,130,246,.1);
        }
        .modal-actions { display: flex; gap: .75rem; margin-top: 1.5rem; justify-content: flex-end; }
        .btn-ghost {
            height: 38px; padding: 0 16px; background: transparent;
            border: 1px solid var(--border); border-radius: 100px;
            color: var(--text-secondary); font-size: .875rem; cursor: pointer;
            font-family: 'Inter', sans-serif;
        }
        .btn-ghost:hover { border-color: var(--border-mid); color: var(--text-primary); }

        /* ── Owner drawer ── */
        .drawer-overlay {
            display: none; position: fixed; inset: 0; z-index: 250;
            background: rgba(15,23,42,.3);
        }
        .drawer-overlay.open { display: block; }
        .drawer {
            position: fixed; right: -520px; top: 0; bottom: 0; width: 500px;
            background: var(--bg-surface); border-left: 1px solid var(--border);
            z-index: 260; overflow-y: auto;
            transition: right .3s var(--ease);
            padding: 2rem; box-shadow: var(--shadow-drawer);
        }
        .drawer.open { right: 0; }
        .drawer-header {
            display: flex; align-items: flex-start; justify-content: space-between;
            margin-bottom: 1.5rem;
        }
        .drawer-close { background: none; border: none; color: var(--text-tertiary); cursor: pointer; font-size: 1.25rem; padding: 2px; }
        .drawer-close:hover { color: var(--text-primary); }
        .drawer-section { margin-bottom: 1.5rem; }
        .drawer-section-title {
            font-family: 'Manrope', sans-serif; font-weight: 700; font-size: .875rem;
            margin-bottom: .75rem; display: flex; align-items: center; gap: 6px;
        }
        .drawer-section-title i { color: var(--accent-blue); }
        .kyc-actions { display: flex; gap: .5rem; margin-top: .75rem; }
        .btn-kyc {
            height: 32px; padding: 0 12px; border-radius: 100px;
            font-size: .78rem; font-weight: 600; cursor: pointer; border: 1px solid;
            font-family: 'Inter', sans-serif;
        }
        .btn-kyc.verify  { background: #D1FAE5; color: #065F46; border-color: #A7F3D0; }
        .btn-kyc.reject  { background: #FEE2E2; color: #991B1B; border-color: #FECACA; }
        .btn-kyc.pending { background: #FEF3C7; color: #92400E; border-color: #FDE68A; }
        .btn-kyc:hover { opacity: .8; }
        .timeline { display: flex; flex-direction: column; gap: 0; }
        .timeline-item { display: flex; gap: 12px; padding-bottom: 1.25rem; position: relative; }
        .timeline-item::before { content:''; position:absolute; left:13px; top:26px; bottom:0; width:1px; background:var(--border); }
        .timeline-item:last-child::before { display:none; }
        .timeline-dot {
            width: 28px; height: 28px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; background: var(--bg-muted);
            border: 1px solid var(--border); font-size: .75rem; color: var(--text-tertiary);
        }
        .timeline-dot.current { background: #DBEAFE; border-color: #93C5FD; color: var(--accent-blue); }
        .tl-title { font-size: .84rem; font-weight: 600; }
        .tl-sub   { font-size: .76rem; color: var(--text-secondary); margin-top: 2px; }
        .icon-btn {
            background: none; border: 1px solid var(--border); border-radius: var(--radius-sm);
            width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--text-secondary); font-size: .9rem;
        }
        .icon-btn:hover { border-color: var(--accent-blue); color: var(--accent-blue); }
        .info-chip {
            padding: 5px 12px; border-radius: variable; font-size: .8rem;
            display: inline-flex; align-items: center; gap: 6px;
            background: var(--bg-muted); color: var(--text-secondary);
        }

        @media (max-width: 1100px) {
            .kpi-strip { grid-template-columns: repeat(3, 1fr); }
            .verify-layout { grid-template-columns: 1fr; }
            .id-sections { grid-template-columns: 1fr; }
            .id-section { border-right: none; border-bottom: 1px solid var(--border); }
        }
    </style>
</head>
<body>

<!-- ── Sidebar ── -->
<nav class="sidebar">
    <div class="brand-icon">
        <i class="ri-truck-fill"></i>
        <span class="brand-text">TruFleet</span>
    </div>
    <div class="nav-menu" id="navMenu">
        <a href="dashboard.html"          class="nav-item"><i class="ri-dashboard-line"></i><span class="nav-label">Dashboard</span></a>
        <a href="vehicle_management.html" class="nav-item"><i class="ri-car-line"></i><span class="nav-label">Fleet Management</span></a>
        <a href="drivers.html"            class="nav-item"><i class="ri-steering-2-line"></i><span class="nav-label">Drivers</span></a>
        <a href="maintenance.html"        class="nav-item"><i class="ri-tools-line"></i><span class="nav-label">Maintenance</span></a>
        <a href="insurance_monitor.html"  class="nav-item"><i class="ri-shield-check-line"></i><span class="nav-label">Insurance</span></a>
        <a href="dispatch.html"           class="nav-item"><i class="ri-traffic-light-line"></i><span class="nav-label">Dispatch Control</span></a>
        <a href="identity.html"           class="nav-item active"><i class="ri-fingerprint-line"></i><span class="nav-label">Identity</span></a>
        <a href="owner.html"              class="nav-item"><i class="ri-truck-line"></i><span class="nav-label">Owner Portal</span></a>
        <a href="audits.html"             class="nav-item"><i class="ri-file-list-3-line"></i><span class="nav-label">Audit Log</span></a>
        <a href="email_recipients.html"   class="nav-item"><i class="ri-mail-settings-line"></i><span class="nav-label">Email Config</span></a>
    </div>
    <div style="padding:.5rem 0;">
        <a href="#" class="nav-item" onclick="event.preventDefault();logout();" style="color:#EF4444;">
            <i class="ri-logout-box-r-line"></i><span class="nav-label">Logout</span>
        </a>
    </div>
</nav>

<!-- ── Owner Modal ── -->
<div class="overlay" id="ownerModal">
    <div class="modal">
        <div class="modal-title">
            <span id="ownerModalTitle">Register Owner</span>
            <button class="modal-close" onclick="closeOwnerModal()"><i class="ri-close-line"></i></button>
        </div>
        <form id="ownerForm">
            <div class="form-grid">
                <div class="form-group full">
                    <label>Full Name / Company Name *</label>
                    <input type="text" id="o_name" placeholder="e.g. Rajesh Kumar / ABC Logistics Pvt Ltd" required />
                </div>
                <div class="form-group"><label>Email</label><input type="email" id="o_email" placeholder="owner@example.com" /></div>
                <div class="form-group"><label>Phone</label><input type="tel" id="o_phone" placeholder="+91 98765 43210" /></div>
                <div class="form-group"><label>License / Company Reg. No.</label><input type="text" id="o_license" placeholder="DL-0420110012345" /></div>
                <div class="form-group"><label>License Type</label>
                    <select id="o_license_type">
                        <option value="individual">Individual</option>
                        <option value="company">Company</option>
                    </select>
                </div>
                <div class="form-group full"><label>Address</label><textarea id="o_address" placeholder="Full address..."></textarea></div>
                <div class="form-group"><label>KYC Status</label>
                    <select id="o_kyc">
                        <option value="pending">Pending</option>
                        <option value="verified">Verified</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-ghost" onclick="closeOwnerModal()">Cancel</button>
                <button type="submit" class="btn-primary"><i class="ri-save-line"></i> Save Owner</button>
            </div>
        </form>
    </div>
</div>

<!-- ── Policy Modal ── -->
<div class="overlay" id="policyModal">
    <div class="modal">
        <div class="modal-title">
            <span>Add Insurance Policy</span>
            <button class="modal-close" onclick="closePolicyModal()"><i class="ri-close-line"></i></button>
        </div>
        <form id="policyForm">
            <div class="form-grid">
                <div class="form-group full"><label>Vehicle Reg. Number *</label>
                    <input type="text" id="p_vehicle_id" placeholder="e.g. MH12DE1433" style="text-transform:uppercase;" required />
                </div>
                <div class="form-group"><label>Insurance Provider *</label><input type="text" id="p_provider" placeholder="New India Assurance" required /></div>
                <div class="form-group"><label>Policy Number *</label><input type="text" id="p_policy_number" placeholder="NIA/2025/123456" required /></div>
                <div class="form-group"><label>Policy Type</label>
                    <select id="p_policy_type">
                        <option value="comprehensive">Comprehensive</option>
                        <option value="third_party">Third Party</option>
                        <option value="commercial">Commercial</option>
                    </select>
                </div>
                <div class="form-group"><label>Premium (₹)</label><input type="number" id="p_premium" placeholder="45000" min="0" /></div>
                <div class="form-group"><label>Valid From *</label><input type="date" id="p_valid_from" required /></div>
                <div class="form-group"><label>Valid Until *</label><input type="date" id="p_valid_until" required /></div>
                <div class="form-group"><label>Nominee</label><input type="text" id="p_nominee" placeholder="Nominee name" /></div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-ghost" onclick="closePolicyModal()">Cancel</button>
                <button type="submit" class="btn-primary"><i class="ri-save-line"></i> Save Policy</button>
            </div>
        </form>
    </div>
</div>

<!-- ── Owner Detail Drawer ── -->
<div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>
<div class="drawer" id="ownerDrawer">
    <div class="drawer-header">
        <div>
            <div id="drawerOwnerName" style="font-family:'Manrope',sans-serif;font-weight:700;font-size:1.15rem;"></div>
            <div id="drawerOwnerSub" style="font-size:.82rem;color:var(--text-secondary);margin-top:3px;"></div>
        </div>
        <button class="drawer-close" onclick="closeDrawer()"><i class="ri-close-line"></i></button>
    </div>
    <div id="drawerContent"><div class="empty-placeholder"><i class="ri-loader-4-line"></i><p>Loading…</p></div></div>
</div>

<!-- ── Main ── -->
<div class="main-wrapper">
    <header>
        <div class="header-title">
            <h1><i class="ri-fingerprint-line"></i> Identity Management</h1>
            <span>Owner &amp; Insurance Identity Verification</span>
        </div>
        <div class="header-actions">
            <div class="user-profile" id="userProfile">
                <div class="avatar" id="userAvatar">A</div>
            </div>
        </div>
    </header>

    <div class="page-content">

        <!-- KPI strip -->
        <div class="kpi-strip">
            <div class="kpi-card"><div class="kpi-label">Verified Today</div><div class="kpi-value green" id="stat-auth">—</div></div>
            <div class="kpi-card"><div class="kpi-label">Denied Today</div><div class="kpi-value red"   id="stat-denied">—</div></div>
            <div class="kpi-card"><div class="kpi-label">Auth Rate</div><div class="kpi-value blue"  id="stat-rate">—</div></div>
            <div class="kpi-card"><div class="kpi-label">Expired Policies</div><div class="kpi-value red" id="stat-expired">—</div></div>
            <div class="kpi-card"><div class="kpi-label">KYC Pending</div><div class="kpi-value amber" id="stat-kyc">—</div></div>
            <div class="kpi-card"><div class="kpi-label">Verified Owners</div><div class="kpi-value green" id="stat-owners">—</div></div>
        </div>

        <!-- Tab bar -->
        <div class="tab-bar">
            <button class="tab-btn active" onclick="switchTab('verify')" id="tab-verify"><i class="ri-shield-check-line"></i> Verify Identity</button>
            <button class="tab-btn" onclick="switchTab('owners')" id="tab-owners"><i class="ri-team-line"></i> Owners</button>
            <button class="tab-btn" onclick="switchTab('policies')" id="tab-policies"><i class="ri-file-shield-2-line"></i> Insurance Policies</button>
        </div>

        <!-- ── VERIFY TAB ── -->
        <div class="tab-panel active" id="panel-verify">
            <div class="verify-layout">

                <!-- Left: chain -->
                <div>
                    <div class="card">
                        <div class="card-title"><i class="ri-search-eye-line"></i> Vehicle Identity Check</div>
                        <div class="search-row">
                            <input type="text" id="verifyInput" placeholder="Enter registration number…"
                                   onkeyup="if(event.key==='Enter')runVerify()" />
                            <button class="btn-verify" id="verifyBtn" onclick="runVerify()">
                                <i class="ri-scan-2-line"></i> Verify
                            </button>
                        </div>
                        <div class="chain-box" id="chainBox"></div>
                    </div>
                </div>

                <!-- Right: result card -->
                <div>
                    <div class="id-card" id="idCard">
                        <div class="id-card-banner" id="idBanner">
                            <div>
                                <div class="verdict" id="verdictBadge"></div>
                                <div id="denialReasonBox" class="denial-reason" style="display:none;"></div>
                            </div>
                            <div id="verdictMeta" style="font-size:.8rem;color:var(--text-secondary);"></div>
                        </div>
                        <div class="id-sections">
                            <div class="id-section">
                                <div class="id-section-title"><i class="ri-car-line"></i> Vehicle</div>
                                <div id="idVehicle"></div>
                            </div>
                            <div class="id-section">
                                <div class="id-section-title"><i class="ri-user-line"></i> Owner</div>
                                <div id="idOwner"></div>
                            </div>
                            <div class="id-section">
                                <div class="id-section-title"><i class="ri-shield-check-line"></i> Insurance</div>
                                <div id="idInsurance"></div>
                            </div>
                        </div>
                    </div>
                    <div class="empty-placeholder" id="verifyPlaceholder">
                        <i class="ri-fingerprint-line"></i>
                        <p>Enter a vehicle registration number and click Verify.<br/>
                           The full 7-step ownership &amp; insurance chain will be checked.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ── OWNERS TAB ── -->
        <div class="tab-panel" id="panel-owners">
            <div class="toolbar">
                <div class="search-wrap">
                    <i class="ri-search-line"></i>
                    <input class="search-input" id="ownerSearch" placeholder="Search name, email, phone…" oninput="filterOwners()" />
                </div>
                <button class="filter-btn active" onclick="setOwnerFilter('all',this)">All</button>
                <button class="filter-btn" onclick="setOwnerFilter('verified',this)">Verified</button>
                <button class="filter-btn" onclick="setOwnerFilter('pending',this)">Pending KYC</button>
                <button class="filter-btn" onclick="setOwnerFilter('rejected',this)">Rejected</button>
                <div style="flex:1;"></div>
                <button class="btn-primary" onclick="openOwnerModal()"><i class="ri-add-line"></i> Add Owner</button>
            </div>
            <div class="owners-grid" id="ownersGrid">
                <div class="empty-placeholder" style="grid-column:1/-1"><i class="ri-loader-4-line"></i><p>Loading owners…</p></div>
            </div>
        </div>

        <!-- ── POLICIES TAB ── -->
        <div class="tab-panel" id="panel-policies">
            <div class="toolbar">
                <div class="search-wrap">
                    <i class="ri-search-line"></i>
                    <input class="search-input" style="width:300px;" id="policySearch" placeholder="Vehicle, provider, policy no…" oninput="filterPolicies()" />
                </div>
                <button class="filter-btn active" onclick="setPolicyStatus('all',this)">All</button>
                <button class="filter-btn" onclick="setPolicyStatus('active',this)">Active</button>
                <button class="filter-btn" onclick="setPolicyStatus('expired',this)">Expired</button>
                <button class="filter-btn" onclick="setPolicyStatus('cancelled',this)">Cancelled</button>
                <div style="flex:1;"></div>
                <button class="btn-primary" onclick="openPolicyModal()"><i class="ri-add-line"></i> Add Policy</button>
            </div>
            <div class="card" style="padding:0;overflow:hidden;">
                <div class="table-wrap">
                    <table id="policyTable">
                        <thead>
                            <tr>
                                <th>Vehicle</th><th>Provider</th><th>Policy No.</th>
                                <th>Type</th><th>Valid Until</th><th>Days Left</th>
                                <th>Status</th><th></th>
                            </tr>
                        </thead>
                        <tbody id="policyTbody">
                            <tr class="loading-row"><td colspan="8"><i class="ri-loader-4-line"></i> Loading…</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div><!-- /page-content -->
</div><!-- /main-wrapper -->

<script>
/* ═══════════════════════════════════════════════════════════════════════════ */
/*  TruFleet — Identity Management                                             */
/* ═══════════════════════════════════════════════════════════════════════════ */

const API = '/api';
let allOwners   = [];
let allPolicies = [];
let ownerFilter = 'all';
let policyStatusFilter = 'all';
let editingOwnerId = null;

/* ── Init ── */
document.addEventListener('DOMContentLoaded', () => {
    // RBAC guard — only fleet_manager, insurance_agent and admin can access
    TruFleetRBAC.init('identity');

    const user = JSON.parse(localStorage.getItem('trufleet_user') || '{}');
    if (user?.name) {
        const initials = user.name.split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
        document.getElementById('userAvatar').textContent = initials;
    }

    initCheckChain();
    loadStats();
    loadOwners();
    loadPolicies();
});

/* ── Tabs ── */
function switchTab(name) {
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('panel-' + name).classList.add('active');
    document.getElementById('tab-' + name).classList.add('active');
}

/* ── Stats ── */
async function loadStats() {
    try {
        const r = await fetch(`${API}/identity/stats`);
        const s = await r.json();
        document.getElementById('stat-auth').textContent    = s.authorizedToday ?? 0;
        document.getElementById('stat-denied').textContent  = s.deniedToday ?? 0;
        document.getElementById('stat-rate').textContent    = (s.authRate ?? 0) + '%';
        document.getElementById('stat-expired').textContent = s.expiredInsurance ?? 0;
        document.getElementById('stat-kyc').textContent     = s.pendingKyc ?? 0;
        document.getElementById('stat-owners').textContent  = s.verifiedOwners ?? 0;
    } catch(e) { console.error(e); }
}

/* ── Verify chain ── */
const STEPS = [
    { id:'VEHICLE_REGISTRY',   label:'Vehicle Registry Lookup',       icon:'ri-server-line' },
    { id:'VEHICLE_STATUS',     label:'Administrative Status Check',    icon:'ri-shield-check-line' },
    { id:'OWNERSHIP_RECORD',   label:'Ownership Record Lookup',        icon:'ri-user-follow-line' },
    { id:'OWNER_ACTIVE',       label:'Owner Account Status',           icon:'ri-user-heart-line' },
    { id:'OWNER_KYC',          label:'KYC / Identity Verification',    icon:'ri-fingerprint-line' },
    { id:'INSURANCE_POLICY',   label:'Insurance Policy Lookup',        icon:'ri-file-shield-2-line' },
    { id:'INSURANCE_VALIDITY', label:'Insurance Validity Check',       icon:'ri-calendar-check-line' },
];

function initCheckChain() {
    const box = document.getElementById('chainBox');
    box.innerHTML = STEPS.map(s => `
        <div class="check-item idle" id="chk-${s.id}">
            <div class="check-icon"><i class="${s.icon}"></i></div>
            <div class="check-info">
                <div class="check-title">${s.label}</div>
                <div class="check-note" id="chk-note-${s.id}">Waiting…</div>
            </div>
        </div>`).join('');
}

function setCheckState(id, state, note) {
    const el = document.getElementById('chk-' + id);
    if (!el) return;
    el.className = 'check-item ' + state;
    const noteEl = document.getElementById('chk-note-' + id);
    if (noteEl && note) noteEl.textContent = note;
    const iconMap = { pass:'ri-checkbox-circle-fill', fail:'ri-close-circle-fill', warn:'ri-alert-fill', skip:'ri-minus-circle-line', pending:'ri-loader-4-line' };
    const stepDef = STEPS.find(s => s.id === id);
    el.querySelector('.check-icon').innerHTML = `<i class="${iconMap[state] || stepDef?.icon || 'ri-question-line'}"></i>`;
}

async function runVerify() {
    const vid = document.getElementById('verifyInput').value.trim().toUpperCase();
    if (!vid) return;

    const btn = document.getElementById('verifyBtn');
    btn.classList.add('loading');
    btn.innerHTML = '<i class="ri-loader-4-line"></i> Checking…';

    STEPS.forEach(s => setCheckState(s.id, 'pending', 'Checking…'));
    document.getElementById('idCard').classList.remove('visible');
    document.getElementById('verifyPlaceholder').style.display = 'none';

    try {
        const res  = await fetch(`${API}/identity/verify`, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ vehicle_id: vid, actor: 'dashboard' }),
        });
        const data = await res.json();

        for (const check of (data.checks || [])) {
            await new Promise(r => setTimeout(r, 250));
            const state = check.status === 'PASS' ? 'pass' : check.status === 'FAIL' ? 'fail' : check.status === 'WARN' ? 'warn' : 'skip';
            const note  = check.note || check.reason || (check.status === 'PASS' ? 'Passed' : 'Skipped');
            setCheckState(check.step, state, note);
        }

        renderIdCard(data);
        loadStats();
    } catch(e) {
        console.error(e);
        STEPS.forEach(s => setCheckState(s.id, 'idle', 'Error — server unavailable'));
    }

    btn.classList.remove('loading');
    btn.innerHTML = '<i class="ri-scan-2-line"></i> Verify';
}

function renderIdCard(data) {
    document.getElementById('verifyPlaceholder').style.display = 'none';
    const card   = document.getElementById('idCard');
    const banner = document.getElementById('idBanner');
    const ts     = new Date().toLocaleTimeString('en-IN', { hour:'2-digit', minute:'2-digit' });

    const vb = document.getElementById('verdictBadge');
    if (data.result === 'AUTHORIZED') {
        vb.className = 'verdict auth';
        vb.innerHTML = '<i class="ri-checkbox-circle-fill"></i> AUTHORIZED';
        banner.className = 'id-card-banner auth';
        document.getElementById('denialReasonBox').style.display = 'none';
    } else {
        vb.className = 'verdict denied';
        vb.innerHTML = '<i class="ri-close-circle-fill"></i> ACCESS DENIED';
        banner.className = 'id-card-banner denied';
        const rb = document.getElementById('denialReasonBox');
        rb.style.display = 'block';
        rb.textContent   = data.reason || 'Authorization denied';
    }
    document.getElementById('verdictMeta').textContent = `Checked at ${ts}`;

    const v = data.vehicle;
    document.getElementById('idVehicle').innerHTML = v ? `
        <div class="id-field"><div class="lbl">Reg. Number</div><div class="val">${v.id}</div></div>
        <div class="id-field"><div class="lbl">Vehicle</div><div class="val normal">${v.make} ${v.type}</div></div>
        <div class="id-field"><div class="lbl">VIN</div><div class="val">${v.vin || '—'}</div></div>
        <div class="id-field"><div class="lbl">Year</div><div class="val normal">${v.year || '—'}</div></div>
        <div class="id-field"><div class="lbl">Status</div><div class="val normal">
            <span class="status-badge ${(v.status||'').toLowerCase()}">${v.status || '—'}</span>
        </div></div>` : '<p style="color:var(--text-tertiary);font-size:.84rem;">Not found in registry</p>';

    const o = data.owner;
    document.getElementById('idOwner').innerHTML = o ? `
        <div class="id-field"><div class="lbl">Name</div><div class="val normal">${o.name}</div></div>
        <div class="id-field"><div class="lbl">Email</div><div class="val">${o.email || '—'}</div></div>
        <div class="id-field"><div class="lbl">Type</div><div class="val normal">${capitalize(o.license_type || '—')}</div></div>
        <div class="id-field"><div class="lbl">KYC</div><div class="val normal">
            <span class="kyc-badge ${o.kyc_status}">${capitalize(o.kyc_status || '—')}</span>
        </div></div>` : '<p style="color:var(--text-tertiary);font-size:.84rem;">No owner on record</p>';

    const p = data.policy;
    document.getElementById('idInsurance').innerHTML = p ? `
        <div class="id-field"><div class="lbl">Provider</div><div class="val normal">${p.provider}</div></div>
        <div class="id-field"><div class="lbl">Policy No.</div><div class="val">${p.policy_number}</div></div>
        <div class="id-field"><div class="lbl">Expires</div><div class="val">${p.valid_until}</div></div>
        <div class="id-field"><div class="lbl">Days Left</div><div class="val normal">
            <span class="risk-badge ${p.days_remaining < 0 ? 'expired' : p.days_remaining <= 7 ? 'critical' : p.days_remaining <= 30 ? 'warning' : 'safe'}">
                ${p.days_remaining < 0 ? 'Expired ' + Math.abs(p.days_remaining) + 'd ago' : p.days_remaining + ' days'}
            </span>
        </div></div>` : '<p style="color:var(--text-tertiary);font-size:.84rem;">No active policy found</p>';

    card.classList.add('visible');
    gsap.fromTo(card, { opacity:0, y:12 }, { opacity:1, y:0, duration:.4, ease:'power2.out' });
}

/* ── Owners ── */
async function loadOwners() {
    try {
        const res = await fetch(`${API}/owners`);
        allOwners = await res.json();
        renderOwners();
    } catch(e) {
        document.getElementById('ownersGrid').innerHTML = `<div class="empty-placeholder" style="grid-column:1/-1"><i class="ri-error-warning-line"></i><p>Failed to load owners</p></div>`;
    }
}

function filterOwners() { renderOwners(); }
function setOwnerFilter(f, btn) {
    ownerFilter = f;
    document.querySelectorAll('.toolbar .filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderOwners();
}

function renderOwners() {
    const q = (document.getElementById('ownerSearch').value || '').toLowerCase();
    let list = allOwners;
    if (ownerFilter !== 'all') list = list.filter(o => o.kyc_status === ownerFilter);
    if (q) list = list.filter(o =>
        (o.name||'').toLowerCase().includes(q) ||
        (o.email||'').toLowerCase().includes(q) ||
        (o.phone||'').toLowerCase().includes(q) ||
        (o.license_number||'').toLowerCase().includes(q)
    );

    const grid = document.getElementById('ownersGrid');
    if (!list.length) {
        grid.innerHTML = `<div class="empty-placeholder" style="grid-column:1/-1"><i class="ri-user-search-line"></i><p>No owners found</p></div>`;
        return;
    }

    const COLORS = ['#3B82F6','#10B981','#F59E0B','#EF4444','#8B5CF6','#06B6D4','#EC4899'];
    const kycMap = {
        verified: `<span class="kyc-badge verified"><i class="ri-check-line"></i> Verified</span>`,
        pending:  `<span class="kyc-badge pending"><i class="ri-time-line"></i> Pending</span>`,
        rejected: `<span class="kyc-badge rejected"><i class="ri-close-line"></i> Rejected</span>`,
    };

    grid.innerHTML = list.map((o, i) => {
        const bg       = o.avatar_color || COLORS[i % COLORS.length];
        const initials = (o.name||'?').split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
        const vCount   = o.current_vehicle_count || 0;
        return `
        <div class="owner-card" onclick="openOwnerDrawer('${o.id}')">
            <div class="owner-top">
                <div class="owner-avatar" style="background:${bg}">${initials}</div>
                <div>
                    <div class="owner-name">${o.name}</div>
                    <div class="owner-sub">${capitalize(o.license_type || 'individual')}</div>
                </div>
            </div>
            <div class="owner-meta">
                <div class="owner-meta-item"><i class="ri-mail-line"></i>${o.email || '—'}</div>
                <div class="owner-meta-item"><i class="ri-phone-line"></i>${o.phone || '—'}</div>
                <div class="owner-meta-item"><i class="ri-car-line"></i>${vCount} vehicle${vCount!==1?'s':''}</div>
                <div class="owner-meta-item"><i class="ri-id-card-line"></i>${o.license_number || '—'}</div>
            </div>
            <div class="owner-footer">
                ${kycMap[o.kyc_status] || ''}
                <button class="icon-btn" onclick="event.stopPropagation();openOwnerEditor('${o.id}')">
                    <i class="ri-edit-line"></i>
                </button>
            </div>
        </div>`;
    }).join('');

    gsap.fromTo('.owner-card', { opacity:0, y:16 }, { opacity:1, y:0, duration:.35, stagger:.04, ease:'power2.out' });
}

/* ── Owner Modal ── */
function openOwnerModal() {
    editingOwnerId = null;
    document.getElementById('ownerModalTitle').textContent = 'Register Owner';
    document.getElementById('ownerForm').reset();
    document.getElementById('ownerModal').classList.add('open');
}
function openOwnerEditor(id) {
    const o = allOwners.find(x => x.id === id);
    if (!o) return;
    editingOwnerId = id;
    document.getElementById('ownerModalTitle').textContent = 'Edit Owner';
    document.getElementById('o_name').value         = o.name || '';
    document.getElementById('o_email').value        = o.email || '';
    document.getElementById('o_phone').value        = o.phone || '';
    document.getElementById('o_license').value      = o.license_number || '';
    document.getElementById('o_license_type').value = o.license_type || 'individual';
    document.getElementById('o_address').value      = o.address || '';
    document.getElementById('o_kyc').value          = o.kyc_status || 'pending';
    document.getElementById('ownerModal').classList.add('open');
}
function closeOwnerModal() {
    document.getElementById('ownerModal').classList.remove('open');
    editingOwnerId = null;
}
document.getElementById('ownerForm').addEventListener('submit', async e => {
    e.preventDefault();
    const body = {
        name:          document.getElementById('o_name').value.trim(),
        email:         document.getElementById('o_email').value.trim() || null,
        phone:         document.getElementById('o_phone').value.trim() || null,
        license_number:document.getElementById('o_license').value.trim() || null,
        license_type:  document.getElementById('o_license_type').value,
        address:       document.getElementById('o_address').value.trim() || null,
        kyc_status:    document.getElementById('o_kyc').value,
    };
    const url    = editingOwnerId ? `${API}/owners/${editingOwnerId}` : `${API}/owners`;
    const method = editingOwnerId ? 'PATCH' : 'POST';
    try {
        const res = await fetch(url, { method, headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
        if (!res.ok) { const err = await res.json(); throw new Error(err.error || 'Save failed'); }
        closeOwnerModal(); loadOwners(); loadStats();
    } catch(err) { alert(err.message); }
});

/* ── Owner Drawer ── */
async function openOwnerDrawer(id) {
    document.getElementById('ownerDrawer').classList.add('open');
    document.getElementById('drawerOverlay').classList.add('open');
    document.getElementById('drawerContent').innerHTML = '<div class="empty-placeholder"><i class="ri-loader-4-line"></i><p>Loading…</p></div>';
    document.getElementById('drawerOwnerName').textContent = '…';
    document.getElementById('drawerOwnerSub').textContent  = '';

    try {
        const data = await (await fetch(`${API}/owners/${id}`)).json();
        document.getElementById('drawerOwnerName').textContent = data.name;
        document.getElementById('drawerOwnerSub').textContent  = `${capitalize(data.license_type||'')} · ${data.license_number || 'No license on file'}`;

        const ownedVehicles = (data.ownerships||[]).filter(o=>o.is_current);
        const history       = (data.ownerships||[]).filter(o=>!o.is_current);

        document.getElementById('drawerContent').innerHTML = `
            <div class="drawer-section">
                <div class="drawer-section-title"><i class="ri-fingerprint-line"></i> KYC Status</div>
                <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-muted);border-radius:var(--radius-sm);border:1px solid var(--border);">
                    <span class="kyc-badge ${data.kyc_status}" style="font-size:.8rem;padding:4px 12px;">${capitalize(data.kyc_status)}</span>
                    <div style="font-size:.8rem;color:var(--text-secondary);">${data.kyc_note || 'No note'}</div>
                </div>
                <div class="kyc-actions">
                    <button class="btn-kyc verify"  onclick="updateKyc('${id}','verified')"><i class="ri-check-line"></i> Mark Verified</button>
                    <button class="btn-kyc pending" onclick="updateKyc('${id}','pending')"><i class="ri-time-line"></i> Set Pending</button>
                    <button class="btn-kyc reject"  onclick="updateKyc('${id}','rejected')"><i class="ri-close-line"></i> Reject</button>
                </div>
            </div>
            <div class="drawer-section">
                <div class="drawer-section-title"><i class="ri-car-line"></i> Active Vehicles (${ownedVehicles.length})</div>
                ${ownedVehicles.length ? ownedVehicles.map(ow => `
                <div style="padding:10px 12px;background:var(--bg-muted);border-radius:var(--radius-sm);margin-bottom:6px;display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border);">
                    <div>
                        <div style="font-size:.86rem;font-weight:600;font-family:'JetBrains Mono',monospace;">${ow.vehicle_id}</div>
                        <div style="font-size:.75rem;color:var(--text-secondary);">${capitalize(ow.ownership_type)} · Since ${ow.from_date}</div>
                    </div>
                    <span class="tag ${(ow.vehicles?.status||'').toLowerCase()}">${ow.vehicles?.status||'—'}</span>
                </div>`).join('') : '<p style="font-size:.82rem;color:var(--text-tertiary);">No active vehicles</p>'}
            </div>
            ${history.length ? `
            <div class="drawer-section">
                <div class="drawer-section-title"><i class="ri-history-line"></i> Past Ownerships</div>
                <div class="timeline">
                ${history.map(ow => `
                    <div class="timeline-item">
                        <div class="timeline-dot"><i class="ri-car-line"></i></div>
                        <div>
                            <div class="tl-title">${ow.vehicle_id} — ${capitalize(ow.ownership_type)}</div>
                            <div class="tl-sub">${ow.from_date} → ${ow.to_date||'now'} · ${ow.transfer_reason||''}</div>
                        </div>
                    </div>`).join('')}
                </div>
            </div>` : ''}`;
    } catch(e) {
        document.getElementById('drawerContent').innerHTML = `<div class="empty-placeholder"><i class="ri-error-warning-line"></i><p>Failed to load</p></div>`;
    }
}

async function updateKyc(ownerId, status) {
    const note = status === 'rejected' ? (prompt('Rejection reason (optional):') || '') : '';
    try {
        const res = await fetch(`${API}/owners/${ownerId}/kyc`, {
            method:'PATCH', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ kyc_status: status, kyc_note: note }),
        });
        if (!res.ok) throw new Error('KYC update failed');
        loadOwners(); openOwnerDrawer(ownerId); loadStats();
    } catch(e) { alert(e.message); }
}
function closeDrawer() {
    document.getElementById('ownerDrawer').classList.remove('open');
    document.getElementById('drawerOverlay').classList.remove('open');
}

/* ── Policies ── */
async function loadPolicies() {
    try {
        allPolicies = await (await fetch(`${API}/insurance`)).json();
        renderPolicies();
    } catch(e) {
        document.getElementById('policyTbody').innerHTML = `<tr class="loading-row"><td colspan="8">Failed to load policies</td></tr>`;
    }
}
function filterPolicies() { renderPolicies(); }
function setPolicyStatus(s, btn) {
    policyStatusFilter = s;
    document.querySelectorAll('#panel-policies .filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderPolicies();
}
function renderPolicies() {
    const q = (document.getElementById('policySearch').value || '').toLowerCase();
    let list = allPolicies;
    if (policyStatusFilter !== 'all') list = list.filter(p => p.status === policyStatusFilter);
    if (q) list = list.filter(p =>
        (p.vehicle_id||'').toLowerCase().includes(q) ||
        (p.provider||'').toLowerCase().includes(q) ||
        (p.policy_number||'').toLowerCase().includes(q)
    );
    const tbody = document.getElementById('policyTbody');
    if (!list.length) { tbody.innerHTML = `<tr class="loading-row"><td colspan="8">No policies found</td></tr>`; return; }
    tbody.innerHTML = list.map(p => {
        const d = p.days_remaining;
        const rColor = d===null||p.status!=='active' ? 'var(--text-tertiary)' : d<0?'var(--accent-red)':d<=7?'var(--accent-red)':d<=30?'var(--accent-amber)':'var(--accent-green)';
        const dLabel = d===null?'—':d<0?`Expired ${Math.abs(d)}d ago`:`${d}d`;
        return `<tr>
            <td><span class="mono">${p.vehicle_id}</span></td>
            <td style="font-weight:500;">${p.provider}</td>
            <td><span class="mono">${p.policy_number}</span></td>
            <td><span style="text-transform:capitalize;color:var(--text-secondary);">${(p.policy_type||'').replace('_',' ')}</span></td>
            <td class="mono">${p.valid_until}</td>
            <td style="color:${rColor};font-weight:600;">${dLabel}</td>
            <td><span class="tag ${p.status}">${capitalize(p.status)}</span></td>
            <td>
                ${p.status==='active'?`<button class="icon-btn" title="Cancel" onclick="cancelPolicy('${p.id}')"><i class="ri-close-circle-line"></i></button>`:''}
                <button class="icon-btn" title="Delete" onclick="deletePolicy('${p.id}')"><i class="ri-delete-bin-line"></i></button>
            </td>
        </tr>`;
    }).join('');
}
function openPolicyModal(vid) {
    document.getElementById('policyForm').reset();
    if (vid) document.getElementById('p_vehicle_id').value = vid;
    document.getElementById('p_valid_from').value  = new Date().toISOString().split('T')[0];
    const ny = new Date(); ny.setFullYear(ny.getFullYear()+1);
    document.getElementById('p_valid_until').value = ny.toISOString().split('T')[0];
    document.getElementById('policyModal').classList.add('open');
}
function closePolicyModal() { document.getElementById('policyModal').classList.remove('open'); }
document.getElementById('policyForm').addEventListener('submit', async e => {
    e.preventDefault();
    const body = {
        vehicle_id:     document.getElementById('p_vehicle_id').value.trim().toUpperCase(),
        provider:       document.getElementById('p_provider').value.trim(),
        policy_number:  document.getElementById('p_policy_number').value.trim(),
        policy_type:    document.getElementById('p_policy_type').value,
        premium_amount: document.getElementById('p_premium').value || null,
        valid_from:     document.getElementById('p_valid_from').value,
        valid_until:    document.getElementById('p_valid_until').value,
        nominee:        document.getElementById('p_nominee').value.trim() || null,
        make_current:   true,
    };
    try {
        const res = await fetch(`${API}/insurance`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
        if (!res.ok) { const err = await res.json(); throw new Error(err.error||'Failed'); }
        closePolicyModal(); loadPolicies(); loadStats();
    } catch(err) { alert(err.message); }
});
async function cancelPolicy(id) {
    if (!confirm('Cancel this policy?')) return;
    await fetch(`${API}/insurance/${id}/status`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify({status:'cancelled',reason:'Cancelled via dashboard'}) });
    loadPolicies();
}
async function deletePolicy(id) {
    if (!confirm('Permanently delete this policy?')) return;
    await fetch(`${API}/insurance/${id}`, { method:'DELETE' });
    loadPolicies();
}

function capitalize(s) { return s ? s.charAt(0).toUpperCase() + s.slice(1) : ''; }
</script>
</body>
</html>
