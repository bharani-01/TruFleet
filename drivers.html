<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TruFleet | Driver Management</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Manrope:wght@500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <script src="trufleet-theme.js"></script>
    <script src="trufleet-api.js"></script>
    <script src="trufleet-notif.js"></script>
    <script src="auth-check.js"></script>
    <script src="rbac.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        :root {
            --bg-body:      #F8FAFC;
            --bg-surface:   #FFFFFF;
            --bg-sidebar:   #0F172A;
            --bg-muted:     #F1F5F9;
            --text-primary: #0F172A;
            --text-secondary:#64748B;
            --text-tertiary: #94A3B8;
            --border:       #E2E8F0;
            --border-mid:   #CBD5E1;
            --accent-blue:  #3B82F6;
            --accent-green: #10B981;
            --accent-amber: #F59E0B;
            --accent-red:   #EF4444;
            --accent-purple:#8B5CF6;
            --sidebar-w:    72px;
            --sidebar-exp:  260px;
            --header-h:     70px;
            --shadow-card:  0 1px 3px 0 rgba(0,0,0,.07), 0 1px 2px -1px rgba(0,0,0,.05);
            --shadow-float: 0 20px 25px -5px rgba(0,0,0,.06), 0 10px 10px -5px rgba(0,0,0,.02);
            --radius-lg: 16px; --radius-md: 12px; --radius-sm: 8px;
            --ease: cubic-bezier(0.4, 0, 0.2, 1);
        }
        * { margin:0; padding:0; box-sizing:border-box; outline:none; }
        body { font-family:'Inter',sans-serif; background:var(--bg-body); color:var(--text-primary); height:100vh; display:flex; overflow:hidden; }

        /* Sidebar */
        .sidebar { width:var(--sidebar-w); background:var(--bg-sidebar); height:100vh; position:fixed; left:0; top:0; display:flex; flex-direction:column; transition:width .3s var(--ease); z-index:200; overflow:hidden; }
        .sidebar:hover { width:var(--sidebar-exp); }
        .brand-icon { padding:1.25rem 0; display:flex; align-items:center; justify-content:center; gap:.75rem; font-size:1.4rem; color:var(--accent-blue); min-height:var(--header-h); overflow:hidden; }
        .brand-text { font-family:'Manrope',sans-serif; font-weight:800; font-size:1rem; color:white; white-space:nowrap; opacity:0; transition:opacity .2s var(--ease) .05s; }
        .sidebar:hover .brand-text { opacity:1; }
        .nav-menu { display:flex; flex-direction:column; flex:1; padding:.5rem 0; gap:2px; overflow-y:auto; overflow-x:hidden; }
        .nav-item { display:flex; align-items:center; gap:1rem; padding:.875rem 1.35rem; color:#94A3B8; font-size:.875rem; font-weight:500; text-decoration:none; transition:all .2s var(--ease); white-space:nowrap; }
        .nav-item:hover { background:rgba(255,255,255,.07); color:white; }
        .nav-item.active { background:rgba(59,130,246,.15); color:var(--accent-blue); border-right:3px solid var(--accent-blue); }
        .nav-item i { font-size:1.25rem; flex-shrink:0; }
        .nav-label { opacity:0; transition:opacity .15s var(--ease); }
        .sidebar:hover .nav-label { opacity:1; }

        /* Layout */
        .main-wrapper { margin-left:var(--sidebar-w); flex:1; display:flex; flex-direction:column; height:100vh; overflow-y:auto; }
        header { height:var(--header-h); background:var(--bg-surface); border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; padding:0 2rem; position:sticky; top:0; z-index:100; box-shadow:var(--shadow-card); }
        .header-title h1 { font-family:'Manrope',sans-serif; font-size:1.25rem; font-weight:700; display:flex; align-items:center; gap:10px; }
        .header-title h1 i { color:var(--accent-blue); }
        .header-title span { color:var(--text-secondary); font-size:.9rem; font-weight:400; }
        .header-actions { display:flex; align-items:center; gap:1rem; }
        .avatar { width:36px; height:36px; border-radius:50%; background:var(--bg-sidebar); color:white; display:flex; align-items:center; justify-content:center; font-size:.9rem; font-weight:600; }
        .page-content { padding:2rem; max-width:1400px; margin:0 auto; width:100%; }

        /* KPI */
        .kpi-strip { display:grid; grid-template-columns:repeat(5,1fr); gap:1rem; margin-bottom:1.75rem; }
        .kpi-card { background:var(--bg-surface); border:1px solid var(--border); border-radius:var(--radius-md); padding:1.1rem 1.25rem; box-shadow:var(--shadow-card); }
        .kpi-label { font-size:.72rem; font-weight:600; text-transform:uppercase; letter-spacing:.06em; color:var(--text-tertiary); margin-bottom:.4rem; }
        .kpi-value { font-family:'Manrope',sans-serif; font-size:1.75rem; font-weight:800; line-height:1; }
        .kpi-value.blue   { color:var(--accent-blue); }
        .kpi-value.green  { color:var(--accent-green); }
        .kpi-value.amber  { color:var(--accent-amber); }
        .kpi-value.red    { color:var(--accent-red); }

        /* Toolbar */
        .toolbar { display:flex; align-items:center; gap:.75rem; margin-bottom:1.25rem; flex-wrap:wrap; }
        .search-wrap { position:relative; }
        .search-wrap i { position:absolute; left:10px; top:50%; transform:translateY(-50%); color:var(--text-tertiary); font-size:.9rem; pointer-events:none; }
        .search-input { height:38px; background:var(--bg-surface); border:1px solid var(--border); border-radius:var(--radius-sm); padding:0 12px 0 34px; color:var(--text-primary); font-size:.875rem; font-family:'Inter',sans-serif; width:240px; transition:border-color .2s, box-shadow .2s; }
        .search-input:focus { border-color:var(--accent-blue); box-shadow:0 0 0 3px rgba(59,130,246,.1); }
        .filter-btn { height:38px; padding:0 14px; background:var(--bg-surface); border:1px solid var(--border); border-radius:var(--radius-sm); color:var(--text-secondary); font-size:.8rem; font-weight:500; cursor:pointer; transition:all .15s; font-family:'Inter',sans-serif; }
        .filter-btn:hover { background:var(--bg-muted); }
        .filter-btn.active { background:var(--bg-sidebar); color:white; border-color:var(--bg-sidebar); }
        .btn-primary { height:38px; padding:0 16px; background:var(--bg-sidebar); border:none; border-radius:100px; color:white; font-size:.875rem; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:7px; transition:all .2s; font-family:'Inter',sans-serif; box-shadow:0 4px 12px rgba(15,23,42,.15); }
        .btn-primary:hover { transform:translateY(-1px); box-shadow:0 8px 20px rgba(15,23,42,.2); }

        /* Driver cards */
        .drivers-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:1rem; }
        .driver-card { background:var(--bg-surface); border:1px solid var(--border); border-radius:var(--radius-md); padding:1.25rem; cursor:pointer; box-shadow:var(--shadow-card); transition:border-color .2s, box-shadow .2s, transform .15s; }
        .driver-card:hover { border-color:var(--accent-blue); box-shadow:var(--shadow-float); transform:translateY(-2px); }
        .driver-top { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
        .driver-avatar { width:46px; height:46px; border-radius:50%; flex-shrink:0; display:flex; align-items:center; justify-content:center; font-family:'Manrope',sans-serif; font-size:1rem; font-weight:800; color:white; }
        .driver-name { font-weight:600; font-size:.9rem; margin-bottom:2px; }
        .driver-sub  { font-size:.78rem; color:var(--text-secondary); }
        .driver-meta { display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-bottom:12px; }
        .driver-meta-item { font-size:.78rem; color:var(--text-secondary); display:flex; align-items:center; gap:5px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .driver-meta-item i { font-size:.8rem; color:var(--text-tertiary); flex-shrink:0; }
        .driver-footer { display:flex; align-items:center; justify-content:space-between; border-top:1px solid var(--border); padding-top:10px; }
        .vehicle-chip { display:inline-flex; align-items:center; gap:5px; background:var(--bg-muted); border-radius:20px; padding:3px 10px; font-size:.76rem; font-weight:600; color:var(--text-secondary); font-family:'JetBrains Mono',monospace; }
        .unassigned-chip { display:inline-flex; align-items:center; gap:5px; background:#FEF3C7; color:#92400E; border-radius:20px; padding:3px 10px; font-size:.76rem; font-weight:600; }

        /* Badges */
        .tag { display:inline-flex; align-items:center; gap:4px; padding:2px 9px; border-radius:20px; font-size:.72rem; font-weight:600; }
        .tag.active    { background:#D1FAE5; color:#065F46; }
        .tag.inactive, .tag.on_leave { background:#FEF3C7; color:#92400E; }
        .tag.suspended { background:#FEE2E2; color:#991B1B; }
        .lic-badge { font-size:.72rem; font-weight:600; padding:2px 8px; border-radius:5px; font-family:'JetBrains Mono',monospace; }
        .lic-badge.ok      { background:#D1FAE5; color:#065F46; }
        .lic-badge.expiring { background:#FEF3C7; color:#92400E; }
        .lic-badge.expired  { background:#FEE2E2; color:#991B1B; }
        .icon-btn { background:none; border:1px solid var(--border); border-radius:var(--radius-sm); width:30px; height:30px; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; color:var(--text-secondary); font-size:.9rem; }
        .icon-btn:hover { border-color:var(--accent-blue); color:var(--accent-blue); }

        /* Modal */
        .overlay { display:none; position:fixed; inset:0; background:rgba(15,23,42,.5); z-index:300; align-items:center; justify-content:center; }
        .overlay.open { display:flex; }
        .modal { background:var(--bg-surface); border:1px solid var(--border); border-radius:var(--radius-lg); padding:2rem; width:600px; max-height:90vh; overflow-y:auto; box-shadow:0 25px 60px rgba(0,0,0,.15); }
        .modal-title { font-family:'Manrope',sans-serif; font-weight:700; font-size:1.1rem; margin-bottom:1.5rem; display:flex; align-items:center; justify-content:space-between; }
        .modal-close { background:none; border:none; color:var(--text-tertiary); cursor:pointer; font-size:1.25rem; }
        .modal-close:hover { color:var(--text-primary); }
        .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:.875rem; }
        .form-group { display:flex; flex-direction:column; gap:.3rem; }
        .form-group.full { grid-column:1/-1; }
        .form-group label { font-size:.78rem; font-weight:600; color:var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { height:38px; background:var(--bg-muted); border:1px solid var(--border); border-radius:var(--radius-sm); padding:0 12px; color:var(--text-primary); font-size:.875rem; font-family:'Inter',sans-serif; transition:border-color .2s, box-shadow .2s; }
        .form-group textarea { height:64px; padding:9px 12px; resize:vertical; }
        .form-group input:focus, .form-group select:focus { border-color:var(--accent-blue); background:white; box-shadow:0 0 0 3px rgba(59,130,246,.1); }
        .modal-actions { display:flex; gap:.75rem; margin-top:1.5rem; justify-content:flex-end; }
        .btn-ghost { height:38px; padding:0 16px; background:transparent; border:1px solid var(--border); border-radius:100px; color:var(--text-secondary); font-size:.875rem; cursor:pointer; font-family:'Inter',sans-serif; }
        .btn-ghost:hover { border-color:var(--border-mid); color:var(--text-primary); }

        /* Assign modal */
        .assign-modal { width:480px; }

        /* Drawer */
        .drawer-overlay { display:none; position:fixed; inset:0; z-index:250; background:rgba(15,23,42,.3); }
        .drawer-overlay.open { display:block; }
        .drawer { position:fixed; right:-520px; top:0; bottom:0; width:500px; background:var(--bg-surface); border-left:1px solid var(--border); z-index:260; overflow-y:auto; transition:right .3s var(--ease); padding:2rem; box-shadow:-10px 0 40px rgba(0,0,0,.08); }
        .drawer.open { right:0; }
        .drawer-header { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:1.5rem; }
        .drawer-close { background:none; border:none; color:var(--text-tertiary); cursor:pointer; font-size:1.25rem; }
        .drawer-close:hover { color:var(--text-primary); }
        .drawer-section { margin-bottom:1.5rem; }
        .drawer-section-title { font-family:'Manrope',sans-serif; font-weight:700; font-size:.875rem; margin-bottom:.75rem; display:flex; align-items:center; gap:6px; }
        .drawer-section-title i { color:var(--accent-blue); }
        .info-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
        .info-item .lbl { font-size:.72rem; color:var(--text-secondary); margin-bottom:2px; }
        .info-item .val { font-size:.875rem; font-weight:600; }
        .info-item .val.mono { font-family:'JetBrains Mono',monospace; }
        .timeline { display:flex; flex-direction:column; gap:0; }
        .timeline-item { display:flex; gap:12px; padding-bottom:1.25rem; position:relative; }
        .timeline-item::before { content:''; position:absolute; left:13px; top:26px; bottom:0; width:1px; background:var(--border); }
        .timeline-item:last-child::before { display:none; }
        .timeline-dot { width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; flex-shrink:0; background:var(--bg-muted); border:1px solid var(--border); font-size:.75rem; color:var(--text-tertiary); }
        .timeline-dot.current { background:#DBEAFE; border-color:#93C5FD; color:var(--accent-blue); }
        .tl-title { font-size:.84rem; font-weight:600; }
        .tl-sub   { font-size:.76rem; color:var(--text-secondary); margin-top:2px; }
        .empty-placeholder { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; padding:3rem; color:var(--text-tertiary); text-align:center; grid-column:1/-1; }
        .empty-placeholder i { font-size:2.5rem; opacity:.4; }
        .empty-placeholder p { font-size:.875rem; line-height:1.5; }
    </style>
</head>
<body>

<nav class="sidebar">
    <div class="brand-icon"><i class="ri-truck-fill"></i><span class="brand-text">TruFleet</span></div>
    <div class="nav-menu" id="navMenu">
        <a href="dashboard.html"          class="nav-item"><i class="ri-dashboard-line"></i><span class="nav-label">Dashboard</span></a>
        <a href="vehicle_management.html" class="nav-item"><i class="ri-car-line"></i><span class="nav-label">Fleet Management</span></a>
        <a href="drivers.html"            class="nav-item active"><i class="ri-steering-2-line"></i><span class="nav-label">Drivers</span></a>
        <a href="maintenance.html"        class="nav-item"><i class="ri-tools-line"></i><span class="nav-label">Maintenance</span></a>
        <a href="insurance_monitor.html"  class="nav-item"><i class="ri-shield-check-line"></i><span class="nav-label">Insurance</span></a>
        <a href="dispatch.html"           class="nav-item"><i class="ri-traffic-light-line"></i><span class="nav-label">Dispatch Control</span></a>
        <a href="identity.html"           class="nav-item"><i class="ri-fingerprint-line"></i><span class="nav-label">Identity</span></a>
        <a href="owner.html"              class="nav-item"><i class="ri-truck-line"></i><span class="nav-label">Owner Portal</span></a>
        <a href="audits.html"             class="nav-item"><i class="ri-file-list-3-line"></i><span class="nav-label">Audit Log</span></a>
        <a href="email_recipients.html"   class="nav-item"><i class="ri-mail-settings-line"></i><span class="nav-label">Email Config</span></a>
    </div>
    <div style="padding:.5rem 0;">
        <a href="#" class="nav-item" onclick="event.preventDefault();logout();" style="color:#EF4444;">
            <i class="ri-logout-box-r-line"></i><span class="nav-label">Logout</span>
        </a>
    </div>
</nav>

<!-- Driver Modal -->
<div class="overlay" id="driverModal">
    <div class="modal">
        <div class="modal-title">
            <span id="driverModalTitle">Add Driver</span>
            <button class="modal-close" onclick="closeDriverModal()"><i class="ri-close-line"></i></button>
        </div>
        <form id="driverForm">
            <div class="form-grid">
                <div class="form-group full">
                    <label>Full Name *</label>
                    <input type="text" id="d_name" placeholder="e.g. Ravi Kumar" required />
                </div>
                <div class="form-group"><label>Email</label><input type="email" id="d_email" placeholder="ravi@example.com" /></div>
                <div class="form-group"><label>Phone</label><input type="tel" id="d_phone" placeholder="+91 98765 43210" /></div>
                <div class="form-group"><label>License Number *</label><input type="text" id="d_license_number" placeholder="DL-0420110012345" required style="text-transform:uppercase;" /></div>
                <div class="form-group">
                    <label>License Type</label>
                    <select id="d_license_type">
                        <option value="LMV-TR">LMV-TR (Transport)</option>
                        <option value="LMV">LMV</option>
                        <option value="HMV">HMV</option>
                        <option value="HGMV">HGMV</option>
                        <option value="HMVT">HMVT</option>
                        <option value="PSV">PSV</option>
                    </select>
                </div>
                <div class="form-group"><label>License Expiry *</label><input type="date" id="d_license_expiry" required /></div>
                <div class="form-group"><label>Date of Birth</label><input type="date" id="d_dob" /></div>
                <div class="form-group">
                    <label>Blood Group</label>
                    <select id="d_blood">
                        <option value="">Select</option>
                        <option>A+</option><option>A-</option>
                        <option>B+</option><option>B-</option>
                        <option>O+</option><option>O-</option>
                        <option>AB+</option><option>AB-</option>
                    </select>
                </div>
                <div class="form-group"><label>Experience (years)</label><input type="number" id="d_experience" min="0" max="50" placeholder="5" /></div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="d_status">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="on_leave">On Leave</option>
                        <option value="suspended">Suspended</option>
                    </select>
                </div>
                <div class="form-group"><label>Emergency Contact Name</label><input type="text" id="d_ec_name" placeholder="Sunita Kumar" /></div>
                <div class="form-group"><label>Emergency Contact Phone</label><input type="tel" id="d_ec_phone" placeholder="+91 87654 32109" /></div>
                <div class="form-group full"><label>Address</label><textarea id="d_address" placeholder="Full address…"></textarea></div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-ghost" onclick="closeDriverModal()">Cancel</button>
                <button type="submit" class="btn-primary"><i class="ri-save-line"></i> Save Driver</button>
            </div>
        </form>
    </div>
</div>

<!-- Assign Modal -->
<div class="overlay" id="assignModal">
    <div class="modal assign-modal">
        <div class="modal-title">
            <span>Assign to Vehicle</span>
            <button class="modal-close" onclick="closeAssignModal()"><i class="ri-close-line"></i></button>
        </div>
        <div id="assignDriverName" style="padding:10px 14px; background:var(--bg-muted); border-radius:var(--radius-sm); margin-bottom:1.25rem; font-weight:600; font-size:.9rem;"></div>
        <div class="form-grid" style="grid-template-columns:1fr;">
            <div class="form-group">
                <label>Vehicle Registration Number *</label>
                <input type="text" id="assign_vehicle" placeholder="e.g. MH12DE1433" style="text-transform:uppercase;" required />
            </div>
            <div class="form-group">
                <label>Notes (optional)</label>
                <input type="text" id="assign_notes" placeholder="Any notes about this assignment…" />
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn-ghost" onclick="closeAssignModal()">Cancel</button>
            <button type="button" class="btn-primary" onclick="submitAssign()"><i class="ri-link"></i> Assign</button>
        </div>
    </div>
</div>

<!-- Drawer -->
<div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>
<div class="drawer" id="driverDrawer">
    <div class="drawer-header">
        <div>
            <div id="drawerDriverName" style="font-family:'Manrope',sans-serif;font-weight:700;font-size:1.15rem;"></div>
            <div id="drawerDriverSub" style="font-size:.82rem;color:var(--text-secondary);margin-top:3px;"></div>
        </div>
        <button class="drawer-close" onclick="closeDrawer()"><i class="ri-close-line"></i></button>
    </div>
    <div id="drawerContent"></div>
</div>

<div class="main-wrapper">
    <header>
        <div class="header-title">
            <h1><i class="ri-steering-2-line"></i> Driver Management</h1>
            <span>Fleet driver profiles, licenses &amp; assignments</span>
        </div>
        <div class="header-actions">
            <div id="userProfile"><div class="avatar" id="userAvatar">CO</div></div>
        </div>
    </header>

    <div class="page-content">
        <div class="kpi-strip">
            <div class="kpi-card"><div class="kpi-label">Total Drivers</div><div class="kpi-value blue"  id="stat-total">—</div></div>
            <div class="kpi-card"><div class="kpi-label">Active</div>      <div class="kpi-value green" id="stat-active">—</div></div>
            <div class="kpi-card"><div class="kpi-label">Inactive / Leave</div><div class="kpi-value amber" id="stat-inactive">—</div></div>
            <div class="kpi-card"><div class="kpi-label">License Expiring &lt;30d</div><div class="kpi-value amber" id="stat-expiring">—</div></div>
            <div class="kpi-card"><div class="kpi-label">Expired License</div><div class="kpi-value red" id="stat-expired">—</div></div>
        </div>

        <div class="toolbar">
            <div class="search-wrap">
                <i class="ri-search-line"></i>
                <input class="search-input" id="driverSearch" placeholder="Search name, license, phone…" oninput="filterDrivers()" />
            </div>
            <button class="filter-btn active" onclick="setFilter('all',this)">All</button>
            <button class="filter-btn" onclick="setFilter('active',this)">Active</button>
            <button class="filter-btn" onclick="setFilter('inactive',this)">Inactive</button>
            <button class="filter-btn" onclick="setFilter('on_leave',this)">On Leave</button>
            <button class="filter-btn" onclick="setFilter('suspended',this)">Suspended</button>
            <button class="filter-btn" id="btnUnassigned" onclick="setFilter('unassigned',this)">Unassigned</button>
            <div style="flex:1;"></div>
            <button class="btn-primary" onclick="openDriverModal()"><i class="ri-add-line"></i> Add Driver</button>
        </div>

        <div class="drivers-grid" id="driversGrid">
            <div class="empty-placeholder"><i class="ri-loader-4-line"></i><p>Loading drivers…</p></div>
        </div>
    </div>
</div>

<script>
const API = '/api';
let allDrivers   = [];
let activeFilter = 'all';

document.addEventListener('DOMContentLoaded', async () => {
    TruFleetRBAC.init('drivers');

    const user = JSON.parse(localStorage.getItem('trufleet_user') || '{}');
    if (user?.name) {
        const ini = user.name.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
        document.getElementById('userAvatar').textContent = ini;
    }
    await Promise.all([loadStats(), loadDrivers()]);
});

async function loadStats() {
    try {
        const s = await (await fetch(`${API}/drivers/stats`)).json();
        document.getElementById('stat-total').textContent    = s.total     ?? 0;
        document.getElementById('stat-active').textContent   = s.active    ?? 0;
        document.getElementById('stat-inactive').textContent = s.inactive  ?? 0;
        document.getElementById('stat-expiring').textContent = s.expiring  ?? 0;
        document.getElementById('stat-expired').textContent  = s.expired   ?? 0;
    } catch(e) { console.error(e); }
}

async function loadDrivers() {
    try {
        allDrivers = await (await fetch(`${API}/drivers`)).json();
        renderDrivers();
    } catch(e) {
        document.getElementById('driversGrid').innerHTML =
            `<div class="empty-placeholder"><i class="ri-error-warning-line"></i><p>Failed to load drivers</p></div>`;
    }
}

function setFilter(f, btn) {
    activeFilter = f;
    document.querySelectorAll('.toolbar .filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    filterDrivers();
}

function filterDrivers() { renderDrivers(); }

function renderDrivers() {
    const q = (document.getElementById('driverSearch').value || '').toLowerCase();
    let list = allDrivers;
    if (activeFilter === 'unassigned') list = list.filter(d => !d.current_vehicle);
    else if (activeFilter !== 'all')   list = list.filter(d => d.status === activeFilter);
    if (q) list = list.filter(d =>
        (d.name||'').toLowerCase().includes(q) ||
        (d.license_number||'').toLowerCase().includes(q) ||
        (d.phone||'').toLowerCase().includes(q) ||
        (d.email||'').toLowerCase().includes(q)
    );

    const grid = document.getElementById('driversGrid');
    if (!list.length) {
        grid.innerHTML = `<div class="empty-placeholder"><i class="ri-user-search-line"></i><p>No drivers found</p></div>`;
        return;
    }

    const COLORS = ['#3B82F6','#10B981','#F59E0B','#EF4444','#8B5CF6','#06B6D4'];
    const today  = new Date();
    const in30   = new Date(); in30.setDate(today.getDate() + 30);

    grid.innerHTML = list.map((d, i) => {
        const bg  = COLORS[i % COLORS.length];
        const ini = (d.name||'?').split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
        const exp = new Date(d.license_expiry);
        const licState = exp < today ? 'expired' : exp <= in30 ? 'expiring' : 'ok';
        const licLabel = licState === 'expired'
            ? 'Expired'
            : licState === 'expiring'
            ? `Exp ${d.license_expiry}`
            : d.license_expiry;
        const vehiclePill = d.current_vehicle
            ? `<span class="vehicle-chip"><i class="ri-car-line"></i>${d.current_vehicle}</span>`
            : `<span class="unassigned-chip"><i class="ri-link-unlink"></i>Unassigned</span>`;
        const statusMap = { active:'active', inactive:'inactive', on_leave:'on_leave', suspended:'suspended' };
        return `
        <div class="driver-card" onclick="openDriverDrawer('${d.id}')">
            <div class="driver-top">
                <div class="driver-avatar" style="background:${bg}">${ini}</div>
                <div>
                    <div class="driver-name">${d.name}</div>
                    <div class="driver-sub">${d.license_type} · ${d.experience_years || 0} yrs exp</div>
                </div>
            </div>
            <div class="driver-meta">
                <div class="driver-meta-item"><i class="ri-phone-line"></i>${d.phone || '—'}</div>
                <div class="driver-meta-item"><i class="ri-mail-line"></i>${d.email || '—'}</div>
                <div class="driver-meta-item"><i class="ri-id-card-line"></i>${d.license_number}</div>
                <div class="driver-meta-item"><i class="ri-drop-line"></i>${d.blood_group || '—'}</div>
            </div>
            <div class="driver-footer">
                <span class="lic-badge ${licState}">${licLabel}</span>
                <div style="display:flex;align-items:center;gap:6px;">
                    <tag class="tag ${statusMap[d.status]||'active'}">${d.status?.replace('_',' ')}</tag>
                    <button class="icon-btn" title="Edit" onclick="event.stopPropagation();openDriverEditor('${d.id}')"><i class="ri-edit-line"></i></button>
                </div>
            </div>
            <div style="margin-top:10px;">${vehiclePill}</div>
        </div>`;
    }).join('');
    gsap.fromTo('.driver-card', { opacity:0, y:16 }, { opacity:1, y:0, duration:.3, stagger:.04, ease:'power2.out' });
}

/* ── Drawer ── */
let drawerDriverId = null;
async function openDriverDrawer(id) {
    drawerDriverId = id;
    document.getElementById('driverDrawer').classList.add('open');
    document.getElementById('drawerOverlay').classList.add('open');
    document.getElementById('drawerContent').innerHTML = `<div class="empty-placeholder"><i class="ri-loader-4-line"></i><p>Loading…</p></div>`;
    try {
        const d = await (await fetch(`${API}/drivers/${id}`)).json();
        document.getElementById('drawerDriverName').textContent = d.name;
        document.getElementById('drawerDriverSub').textContent  = `${d.license_type} · License: ${d.license_number}`;

        const today    = new Date();
        const exp      = new Date(d.license_expiry);
        const daysLeft = Math.ceil((exp - today) / 86400000);
        const licState = daysLeft < 0 ? 'expired' : daysLeft <= 30 ? 'expiring' : 'ok';
        const licColor = licState === 'expired' ? 'var(--accent-red)' : licState === 'expiring' ? 'var(--accent-amber)' : 'var(--accent-green)';

        const current = (d.driver_assignments||[]).find(a => a.is_current);
        const history = (d.driver_assignments||[]).filter(a => !a.is_current);

        document.getElementById('drawerContent').innerHTML = `
            <div class="drawer-section">
                <div class="drawer-section-title"><i class="ri-user-line"></i> Personal Details</div>
                <div class="info-grid">
                    <div class="info-item"><div class="lbl">Phone</div><div class="val">${d.phone||'—'}</div></div>
                    <div class="info-item"><div class="lbl">Email</div><div class="val">${d.email||'—'}</div></div>
                    <div class="info-item"><div class="lbl">DOB</div><div class="val">${d.date_of_birth||'—'}</div></div>
                    <div class="info-item"><div class="lbl">Blood Group</div><div class="val">${d.blood_group||'—'}</div></div>
                    <div class="info-item"><div class="lbl">Experience</div><div class="val">${d.experience_years||0} years</div></div>
                    <div class="info-item"><div class="lbl">Status</div><div class="val"><span class="tag ${d.status}">${(d.status||'').replace('_',' ')}</span></div></div>
                </div>
            </div>
            <div class="drawer-section">
                <div class="drawer-section-title"><i class="ri-id-card-line"></i> License</div>
                <div class="info-grid">
                    <div class="info-item"><div class="lbl">License No.</div><div class="val mono">${d.license_number}</div></div>
                    <div class="info-item"><div class="lbl">Type</div><div class="val">${d.license_type}</div></div>
                    <div class="info-item" style="grid-column:1/-1;">
                        <div class="lbl">Expiry</div>
                        <div class="val" style="color:${licColor};">
                            ${d.license_expiry}
                            ${daysLeft < 0
                                ? ` <span style="font-size:.75rem;font-weight:500;">(Expired ${Math.abs(daysLeft)}d ago)</span>`
                                : ` <span style="font-size:.75rem;font-weight:500;">(${daysLeft}d remaining)</span>`}
                        </div>
                    </div>
                </div>
            </div>
            <div class="drawer-section">
                <div class="drawer-section-title"><i class="ri-car-line"></i> Current Assignment</div>
                ${current
                    ? `<div style="padding:12px;background:var(--bg-muted);border-radius:var(--radius-sm);border:1px solid var(--border);">
                           <div style="font-family:'JetBrains Mono',monospace;font-size:.9rem;font-weight:700;">${current.vehicle_id}</div>
                           <div style="font-size:.76rem;color:var(--text-secondary);margin-top:3px;">Since ${current.assigned_from} · ${current.notes||'No notes'}</div>
                       </div>
                       <button class="btn-ghost" style="margin-top:.75rem;width:100%;justify-content:center;" onclick="unassignDriver('${d.id}')">
                           <i class="ri-link-unlink"></i> Unassign from ${current.vehicle_id}
                       </button>`
                    : `<div style="font-size:.84rem;color:var(--text-tertiary);margin-bottom:.75rem;">Not currently assigned to any vehicle.</div>`
                }
                <button class="btn-primary" style="width:100%;justify-content:center;margin-top:.5rem;" onclick="openAssignModal('${d.id}','${d.name}')">
                    <i class="ri-link"></i> Assign to Vehicle
                </button>
            </div>
            ${d.emergency_contact_name ? `
            <div class="drawer-section">
                <div class="drawer-section-title"><i class="ri-first-aid-kit-line"></i> Emergency Contact</div>
                <div class="info-grid">
                    <div class="info-item"><div class="lbl">Name</div><div class="val">${d.emergency_contact_name||'—'}</div></div>
                    <div class="info-item"><div class="lbl">Phone</div><div class="val">${d.emergency_contact_phone||'—'}</div></div>
                </div>
            </div>` : ''}
            ${history.length ? `
            <div class="drawer-section">
                <div class="drawer-section-title"><i class="ri-history-line"></i> Assignment History</div>
                <div class="timeline">
                    ${history.map(a=>`
                    <div class="timeline-item">
                        <div class="timeline-dot"><i class="ri-car-line"></i></div>
                        <div>
                            <div class="tl-title">${a.vehicle_id}</div>
                            <div class="tl-sub">${a.assigned_from} → ${a.assigned_until||'—'} · ${a.notes||''}</div>
                        </div>
                    </div>`).join('')}
                </div>
            </div>` : ''}`;
    } catch(e) {
        document.getElementById('drawerContent').innerHTML = `<div class="empty-placeholder"><i class="ri-error-warning-line"></i><p>Failed to load</p></div>`;
    }
}
function closeDrawer() {
    document.getElementById('driverDrawer').classList.remove('open');
    document.getElementById('drawerOverlay').classList.remove('open');
}

/* ── Driver Modal ── */
let editingId = null;
function openDriverModal() {
    editingId = null;
    document.getElementById('driverModalTitle').textContent = 'Add Driver';
    document.getElementById('driverForm').reset();
    document.getElementById('d_status').value = 'active';
    document.getElementById('driverModal').classList.add('open');
}
function openDriverEditor(id) {
    const d = allDrivers.find(x => x.id === id);
    if (!d) return;
    editingId = id;
    document.getElementById('driverModalTitle').textContent = 'Edit Driver';
    document.getElementById('d_name').value           = d.name || '';
    document.getElementById('d_email').value          = d.email || '';
    document.getElementById('d_phone').value          = d.phone || '';
    document.getElementById('d_license_number').value = d.license_number || '';
    document.getElementById('d_license_type').value   = d.license_type || 'LMV-TR';
    document.getElementById('d_license_expiry').value = d.license_expiry || '';
    document.getElementById('d_dob').value            = d.date_of_birth || '';
    document.getElementById('d_blood').value          = d.blood_group || '';
    document.getElementById('d_experience').value     = d.experience_years || 0;
    document.getElementById('d_status').value         = d.status || 'active';
    document.getElementById('d_ec_name').value        = d.emergency_contact_name || '';
    document.getElementById('d_ec_phone').value       = d.emergency_contact_phone || '';
    document.getElementById('d_address').value        = d.address || '';
    document.getElementById('driverModal').classList.add('open');
}
function closeDriverModal() {
    document.getElementById('driverModal').classList.remove('open');
    editingId = null;
}
document.getElementById('driverForm').addEventListener('submit', async e => {
    e.preventDefault();
    const body = {
        name: document.getElementById('d_name').value.trim(),
        email: document.getElementById('d_email').value.trim()||null,
        phone: document.getElementById('d_phone').value.trim()||null,
        license_number: document.getElementById('d_license_number').value.trim().toUpperCase(),
        license_type: document.getElementById('d_license_type').value,
        license_expiry: document.getElementById('d_license_expiry').value,
        date_of_birth: document.getElementById('d_dob').value||null,
        blood_group: document.getElementById('d_blood').value||null,
        experience_years: parseInt(document.getElementById('d_experience').value)||0,
        status: document.getElementById('d_status').value,
        emergency_contact_name: document.getElementById('d_ec_name').value.trim()||null,
        emergency_contact_phone: document.getElementById('d_ec_phone').value.trim()||null,
        address: document.getElementById('d_address').value.trim()||null,
    };
    const url    = editingId ? `${API}/drivers/${editingId}` : `${API}/drivers`;
    const method = editingId ? 'PATCH' : 'POST';
    try {
        const res = await fetch(url, { method, headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
        if (!res.ok) throw new Error((await res.json()).error||'Save failed');
        closeDriverModal();
        await Promise.all([loadStats(), loadDrivers()]);
    } catch(err) { alert(err.message); }
});

/* ── Assign Modal ── */
let assigningDriverId = null;
function openAssignModal(id, name) {
    assigningDriverId = id;
    document.getElementById('assignDriverName').textContent = `Driver: ${name}`;
    document.getElementById('assign_vehicle').value = '';
    document.getElementById('assign_notes').value   = '';
    document.getElementById('assignModal').classList.add('open');
    closeDrawer();
}
function closeAssignModal() {
    document.getElementById('assignModal').classList.remove('open');
    assigningDriverId = null;
}
async function submitAssign() {
    const vid = document.getElementById('assign_vehicle').value.trim().toUpperCase();
    if (!vid) return alert('Vehicle registration required');
    try {
        const res = await fetch(`${API}/drivers/${assigningDriverId}/assign`, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ vehicle_id: vid, notes: document.getElementById('assign_notes').value.trim()||null }),
        });
        if (!res.ok) throw new Error((await res.json()).error||'Assign failed');
        closeAssignModal();
        await Promise.all([loadDrivers(), loadStats()]);
    } catch(err) { alert(err.message); }
}
async function unassignDriver(id) {
    if (!confirm('Remove current vehicle assignment?')) return;
    try {
        await fetch(`${API}/drivers/${id}/unassign`, { method:'PATCH', headers:{'Content-Type':'application/json'} });
        closeDrawer();
        await Promise.all([loadDrivers(), loadStats()]);
    } catch(e) { alert(e.message); }
}
</script>
</body>
</html>
