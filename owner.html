<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TruFleet | Owner Portal</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Manrope:wght@500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <script src="trufleet-theme.js"></script>
    <script src="trufleet-api.js"></script>
    <script src="trufleet-notif.js"></script>
    <script src="auth-check.js"></script>
    <script src="rbac.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        :root {
            --bg-body: #F1F5F9;
            --bg-surface: #FFFFFF;
            --bg-sidebar: #0F172A;
            --text-primary: #0F172A;
            --text-secondary: #64748B;
            --accent-blue: #3B82F6;
            --accent-success: #10B981;
            --accent-warning: #F59E0B;
            --accent-danger: #EF4444;
            --sidebar-w: 72px;
            --sidebar-expanded: 260px;
            --header-h: 70px;
            --shadow-card: 0 4px 6px -1px rgba(0,0,0,.05), 0 2px 4px -1px rgba(0,0,0,.03);
            --shadow-float: 0 20px 25px -5px rgba(0,0,0,.06), 0 10px 10px -5px rgba(0,0,0,.02);
            --ease: cubic-bezier(0.4, 0, 0.2, 1);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Inter',sans-serif; background:var(--bg-body); color:var(--text-primary); height:100vh; display:flex; overflow:hidden; }

        /* ── Sidebar ── */
        .sidebar {
            width: var(--sidebar-w); background: var(--bg-sidebar);
            height: 100vh; position: fixed; left: 0; top: 0;
            display: flex; flex-direction: column;
            transition: width .3s var(--ease); z-index: 200; overflow: hidden;
        }
        .sidebar:hover { width: var(--sidebar-expanded); }
        .brand-icon {
            padding: 1.25rem 0; display: flex; align-items: center; justify-content: center;
            gap: .75rem; font-size: 1.4rem; color: var(--accent-blue);
            min-height: var(--header-h); overflow: hidden;
        }
        .brand-text { font-family:'Manrope',sans-serif; font-weight:800; font-size:1rem; color:white; white-space:nowrap; opacity:0; transition:opacity .2s var(--ease) .05s; }
        .sidebar:hover .brand-text { opacity:1; }
        .nav-menu { display:flex; flex-direction:column; flex:1; padding:.5rem 0; gap:2px; }
        .nav-item {
            display:flex; align-items:center; gap:1rem; padding:.875rem 1.35rem;
            color:#94A3B8; font-size:.875rem; font-weight:500;
            text-decoration:none; transition:all .2s var(--ease); white-space:nowrap; position:relative;
        }
        .nav-item:hover { background:rgba(255,255,255,.07); color:white; }
        .nav-item.active { background:rgba(59,130,246,.15); color:var(--accent-blue); border-right:3px solid var(--accent-blue); }
        .nav-item i { font-size:1.25rem; flex-shrink:0; }
        .nav-label { opacity:0; transition:opacity .15s var(--ease); white-space:nowrap; }
        .sidebar:hover .nav-label { opacity:1; }

        /* ── Main ── */
        .main-wrapper { margin-left:var(--sidebar-w); flex:1; display:flex; flex-direction:column; overflow-y:auto; }
        header {
            height:var(--header-h); background:var(--bg-surface);
            border-bottom:1px solid #E2E8F0;
            display:flex; align-items:center; justify-content:space-between;
            padding:0 2rem; position:sticky; top:0; z-index:100;
        }
        .header-title h1 { font-family:'Manrope',sans-serif; font-size:1.25rem; font-weight:700; }
        .header-title span { color:var(--text-secondary); font-size:.9rem; }
        .header-right { display:flex; align-items:center; gap:1.5rem; }
        .avatar { width:36px; height:36px; border-radius:50%; background:var(--bg-sidebar); color:white; display:flex; align-items:center; justify-content:center; font-size:.9rem; font-weight:600; }

        .page-content { padding:2rem; max-width:1400px; margin:0 auto; width:100%; }

        /* ── Summary strip ── */
        .summary-strip { display:grid; grid-template-columns:repeat(4,1fr); gap:1.25rem; margin-bottom:2rem; }
        .sum-card {
            background:var(--bg-surface); border-radius:12px; padding:1.25rem 1.5rem;
            border:1px solid #E2E8F0; box-shadow:var(--shadow-card);
            display:flex; align-items:center; gap:1rem;
            transition:transform .2s var(--ease);
        }
        .sum-card:hover { transform:translateY(-3px); box-shadow:var(--shadow-float); }
        .sum-icon { width:42px; height:42px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:1.25rem; flex-shrink:0; }
        .sum-val { font-family:'Manrope',sans-serif; font-size:1.75rem; font-weight:800; line-height:1; }
        .sum-label { font-size:.8rem; color:var(--text-secondary); margin-top:.2rem; }

        /* ── Toolbar ── */
        .toolbar { display:flex; align-items:center; gap:1rem; margin-bottom:1.5rem; flex-wrap:wrap; }
        .search-box {
            display:flex; align-items:center; gap:.5rem;
            background:var(--bg-surface); border:1px solid #E2E8F0;
            border-radius:8px; padding:.6rem 1rem; flex:1; min-width:220px;
        }
        .search-box input { border:none; background:transparent; outline:none; font-family:'Inter',sans-serif; font-size:.9rem; width:100%; }
        .filter-btn {
            padding:.6rem 1rem; border-radius:8px; border:1.5px solid #E2E8F0;
            background:var(--bg-surface); font-size:.85rem; font-weight:500;
            cursor:pointer; color:var(--text-primary); transition:all .2s;
        }
        .filter-btn:hover, .filter-btn.active { border-color:var(--accent-blue); color:var(--accent-blue); background:#EFF6FF; }

        /* ── Fleet grid ── */
        .fleet-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(340px,1fr)); gap:1.5rem; }

        .vehicle-card {
            background:var(--bg-surface); border-radius:16px;
            border:1px solid #E2E8F0; box-shadow:var(--shadow-card);
            overflow:hidden; transition:all .25s var(--ease);
            cursor:pointer;
        }
        .vehicle-card:hover { transform:translateY(-4px); box-shadow:var(--shadow-float); }

        .vc-status-bar { height:4px; }
        .vc-status-bar.safe { background:var(--accent-success); }
        .vc-status-bar.warn { background:var(--accent-warning); }
        .vc-status-bar.crit { background:var(--accent-danger); }
        .vc-status-bar.blocked { background:#6B7280; }

        .vc-body { padding:1.5rem; }
        .vc-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:1.25rem; }
        .vc-reg { font-family:'JetBrains Mono',monospace; font-size:1rem; font-weight:500; }
        .vc-type { font-size:.8rem; color:var(--text-secondary); margin-top:.25rem; }

        .status-badge {
            display:inline-flex; align-items:center; gap:.3rem;
            padding:.3rem .75rem; border-radius:20px; font-size:.75rem; font-weight:600;
        }
        .badge-active { background:#ECFDF5; color:#065F46; }
        .badge-blocked { background:#F1F5F9; color:#475569; }
        .badge-warn { background:#FFFBEB; color:#92400E; }

        .vc-divider { height:1px; background:#F1F5F9; margin:.25rem 0 1rem; }

        .vc-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:.75rem; font-size:.875rem; }
        .vc-row-label { color:var(--text-secondary); display:flex; align-items:center; gap:.4rem; }
        .vc-row-val { font-weight:600; }

        /* Insurance progress ring */
        .ins-ring-wrap { display:flex; align-items:center; gap:.75rem; margin:.25rem 0 1rem; }
        .ins-ring { position:relative; width:56px; height:56px; flex-shrink:0; }
        .ins-ring svg { transform:rotate(-90deg); }
        .ins-ring-bg { fill:none; stroke:#E2E8F0; stroke-width:5; }
        .ins-ring-fill { fill:none; stroke-width:5; stroke-linecap:round; transition:stroke-dashoffset .6s var(--ease); }
        .ins-ring-text { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-family:'Manrope',sans-serif; font-size:.7rem; font-weight:700; }
        .ins-details { flex:1; }
        .ins-days { font-family:'Manrope',sans-serif; font-size:1rem; font-weight:700; }
        .ins-meta { font-size:.75rem; color:var(--text-secondary); margin-top:.1rem; }

        .vc-actions { display:flex; gap:.75rem; margin-top:1rem; }
        .btn-action {
            flex:1; padding:.6rem; border-radius:8px; border:none;
            font-size:.8rem; font-weight:600; cursor:pointer;
            display:flex; align-items:center; justify-content:center; gap:.4rem;
            transition:all .2s;
        }
        .btn-dispatch { background:#EFF6FF; color:#2563EB; }
        .btn-dispatch:hover { background:#DBEAFE; }
        .btn-details { background:#F8FAFC; color:var(--text-primary); }
        .btn-details:hover { background:#E2E8F0; }

        /* ── Detail Drawer ── */
        .drawer-overlay { position:fixed; inset:0; background:rgba(15,23,42,.3); z-index:300; opacity:0; pointer-events:none; transition:opacity .3s; }
        .drawer-overlay.open { opacity:1; pointer-events:all; }
        .detail-drawer {
            position:fixed; right:-480px; top:0; width:460px; height:100vh;
            background:var(--bg-surface); box-shadow:-20px 0 60px rgba(0,0,0,.1);
            z-index:301; overflow-y:auto;
            transition:right .35s var(--ease);
            display:flex; flex-direction:column;
        }
        .detail-drawer.open { right:0; }
        .drawer-header {
            padding:1.5rem; border-bottom:1px solid #E2E8F0;
            display:flex; justify-content:space-between; align-items:center;
            position:sticky; top:0; background:var(--bg-surface); z-index:1;
        }
        .drawer-title { font-family:'Manrope',sans-serif; font-size:1.1rem; font-weight:700; }
        .close-btn { background:none; border:none; font-size:1.4rem; cursor:pointer; color:var(--text-secondary); line-height:1; }
        .drawer-body { padding:1.5rem; flex:1; }
        .detail-section { margin-bottom:1.75rem; }
        .detail-section h4 { font-size:.75rem; text-transform:uppercase; letter-spacing:.1em; color:var(--text-secondary); margin-bottom:.75rem; }
        .detail-grid { display:grid; grid-template-columns:1fr 1fr; gap:.75rem; }
        .detail-item { background:#F8FAFC; padding:.875rem 1rem; border-radius:8px; border:1px solid #E2E8F0; }
        .detail-item-label { font-size:.75rem; color:var(--text-secondary); margin-bottom:.25rem; }
        .detail-item-val { font-weight:600; font-size:.9rem; word-break:break-all; }

        .compliance-checks { display:flex; flex-direction:column; gap:.5rem; }
        .comp-item {
            display:flex; align-items:center; gap:.75rem; padding:.75rem 1rem;
            border-radius:8px; font-size:.875rem; font-weight:500;
        }
        .comp-pass { background:#ECFDF5; color:#065F46; }
        .comp-fail { background:#FEF2F2; color:#991B1B; }
        .comp-warn { background:#FFFBEB; color:#92400E; }

        /* ── Empty state ── */
        .empty-fleet { text-align:center; padding:4rem 2rem; color:var(--text-secondary); }
        .empty-fleet i { font-size:3rem; margin-bottom:1rem; display:block; color:#CBD5E1; }

        /* ── Notification panel ── */
        #notifPanel { position:fixed; top:0; right:-400px; width:380px; height:100vh; background:white; box-shadow:-10px 0 40px rgba(0,0,0,.08); z-index:300; transition:right .35s var(--ease); display:flex; flex-direction:column; font-family:'Inter',sans-serif; }
        #notifPanel.open { right:0; }

        @media(max-width:900px) { .summary-strip{grid-template-columns:repeat(2,1fr);} }
        @media(max-width:580px) { .summary-strip{grid-template-columns:1fr;} .detail-drawer{width:100%;right:-100%;} .fleet-grid{grid-template-columns:1fr;} }
    </style>
</head>
<body>

<!-- Sidebar -->
<nav class="sidebar">
    <div class="brand-icon">
        <i class="ri-truck-fill"></i>
        <span class="brand-text">TRUFLEET</span>
    </div>
    <div class="nav-menu">
        <a href="dashboard.html" class="nav-item"><i class="ri-dashboard-3-line"></i><span class="nav-label">Overview</span></a>
        <a href="vehicle_management.html" class="nav-item"><i class="ri-bus-line"></i><span class="nav-label">Vehicle Management</span></a>
        <a href="insurance_monitor.html" class="nav-item"><i class="ri-shield-check-line"></i><span class="nav-label">Insurance Monitor</span></a>
        <a href="dispatch.html" class="nav-item"><i class="ri-traffic-light-line"></i><span class="nav-label">Dispatch Control</span></a>
        <a href="owner.html" class="nav-item active"><i class="ri-truck-line"></i><span class="nav-label">Owner Portal</span></a>
        <a href="identity.html" class="nav-item"><i class="ri-fingerprint-line"></i><span class="nav-label">Identity</span></a>
        <a href="email_recipients.html" class="nav-item"><i class="ri-mail-settings-line"></i><span class="nav-label">Email Recipients</span></a>
        <a href="audits.html" class="nav-item"><i class="ri-file-list-3-line"></i><span class="nav-label">Audit Logs</span></a>
        <div style="flex:1"></div>
        <a href="#" class="nav-item" onclick="event.preventDefault();TruFleet.clearCurrentUser();window.location.href='register.html';" style="color:#EF4444;">
            <i class="ri-logout-box-r-line"></i><span class="nav-label">Logout</span>
        </a>
    </div>
</nav>

<!-- Notification Panel -->
<div id="notifPanel">
    <div style="padding:1.5rem;border-bottom:1px solid #E2E8F0;display:flex;justify-content:space-between;align-items:center;">
        <h3 style="font-family:'Manrope';font-size:1.1rem;">Notifications</h3>
        <button onclick="document.getElementById('notifPanel').classList.remove('open')" style="background:none;border:none;cursor:pointer;font-size:1.2rem;color:#94A3B8;"><i class="ri-close-line"></i></button>
    </div>
    <div id="notifList" style="flex:1;overflow-y:auto;padding:.5rem;"></div>
</div>

<!-- Detail Drawer -->
<div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>
<div class="detail-drawer" id="detailDrawer">
    <div class="drawer-header">
        <div class="drawer-title" id="drawerTitle">Vehicle Details</div>
        <button class="close-btn" onclick="closeDrawer()"><i class="ri-close-line"></i></button>
    </div>
    <div class="drawer-body" id="drawerBody"></div>
</div>

<!-- Main -->
<main class="main-wrapper">
    <header>
        <div class="header-title">
            <h1 id="ownerGreeting">Owner Portal</h1>
            <span id="ownerSub">Your fleet at a glance</span>
        </div>
        <div class="header-right">
            <button onclick="document.getElementById('notifPanel').classList.toggle('open');loadNotifs();" style="background:none;border:none;cursor:pointer;position:relative;font-size:1.2rem;color:var(--text-secondary);">
                <i class="ri-notification-3-line"></i>
                <span id="notifBadge" style="display:none;position:absolute;top:-4px;right:-4px;background:#EF4444;color:white;font-size:.6rem;font-weight:700;min-width:16px;height:16px;border-radius:8px;display:flex;align-items:center;justify-content:center;padding:0 3px;">0</span>
            </button>
            <div class="avatar" id="userAvatar">CO</div>
        </div>
    </header>

    <div class="page-content">

        <!-- Summary strip -->
        <div class="summary-strip" id="summaryStrip">
            <div class="sum-card">
                <div class="sum-icon" style="background:#EFF6FF;color:#2563EB;"><i class="ri-truck-line"></i></div>
                <div><div class="sum-val" id="sum-total">—</div><div class="sum-label">Total Vehicles</div></div>
            </div>
            <div class="sum-card">
                <div class="sum-icon" style="background:#ECFDF5;color:#059669;"><i class="ri-checkbox-circle-line"></i></div>
                <div><div class="sum-val" id="sum-active" style="color:#059669;">—</div><div class="sum-label">Dispatch Ready</div></div>
            </div>
            <div class="sum-card">
                <div class="sum-icon" style="background:#FFFBEB;color:#D97706;"><i class="ri-alarm-warning-line"></i></div>
                <div><div class="sum-val" id="sum-expiring" style="color:#D97706;">—</div><div class="sum-label">Insurance Expiring ≤7d</div></div>
            </div>
            <div class="sum-card">
                <div class="sum-icon" style="background:#FEF2F2;color:#DC2626;"><i class="ri-forbid-line"></i></div>
                <div><div class="sum-val" id="sum-blocked" style="color:#DC2626;">—</div><div class="sum-label">Blocked</div></div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="search-box">
                <i class="ri-search-line" style="color:var(--text-secondary);"></i>
                <input type="text" id="searchInput" placeholder="Search by reg number, owner, type…" oninput="filterCards()">
            </div>
            <button class="filter-btn active" id="filter-all" onclick="setFilter('all')">All</button>
            <button class="filter-btn" id="filter-ready" onclick="setFilter('ready')">Dispatch Ready</button>
            <button class="filter-btn" id="filter-expiring" onclick="setFilter('expiring')">Expiring</button>
            <button class="filter-btn" id="filter-blocked" onclick="setFilter('blocked')">Blocked</button>
        </div>

        <!-- Fleet grid -->
        <div class="fleet-grid" id="fleetGrid">
            <div style="grid-column:1/-1;text-align:center;padding:3rem;color:var(--text-secondary);">
                <i class="ri-loader-4-line ri-spin" style="font-size:2rem;display:block;margin-bottom:1rem;"></i>
                Loading your fleet…
            </div>
        </div>

    </div>
</main>

<script>
    let allVehicles = [];
    let currentFilter = 'all';

    /* ── Helpers ── */
    function fmtDate(d) { return d ? new Date(d).toLocaleDateString('en-IN', {day:'numeric',month:'short',year:'numeric'}) : '—'; }

    function riskOf(v) {
        const days = TruFleet.daysUntilExpiry(v.insurance_expiry);
        if ((v.status || '').toLowerCase() === 'blocked') return 'blocked';
        if (days < 0) return 'crit';
        if (days <= 7) return 'warn';
        return 'safe';
    }

    function badgeFor(v) {
        const r = riskOf(v);
        if (r === 'blocked') return `<span class="status-badge badge-blocked"><i class="ri-forbid-line"></i> Blocked</span>`;
        if (r === 'crit') return `<span class="status-badge" style="background:#FEF2F2;color:#991B1B;"><i class="ri-close-circle-line"></i> Insurance Expired</span>`;
        if (r === 'warn') return `<span class="status-badge badge-warn"><i class="ri-alarm-warning-line"></i> Expiring Soon</span>`;
        return `<span class="status-badge badge-active"><i class="ri-checkbox-circle-line"></i> Dispatch Ready</span>`;
    }

    function ringColor(r) {
        if (r === 'safe') return '#10B981';
        if (r === 'warn') return '#F59E0B';
        return '#EF4444';
    }

    function buildCard(v) {
        const risk = riskOf(v);
        const days = TruFleet.daysUntilExpiry(v.insurance_expiry);
        const pct  = Math.max(0, Math.min(100, TruFleet.insuranceHealthPct(v.insurance_expiry)));
        const r = 24, circ = 2 * Math.PI * r;
        const dashOffset = circ - (pct / 100) * circ;
        const color = ringColor(risk);

        return `
        <div class="vehicle-card" onclick="openDrawer('${v.id}')">
            <div class="vc-status-bar ${risk}"></div>
            <div class="vc-body">
                <div class="vc-header">
                    <div>
                        <div class="vc-reg">${v.id || v.vehicle_number || '—'}</div>
                        <div class="vc-type">${v.vehicle_type || '—'} • ${v.make || ''} ${v.model || ''}</div>
                    </div>
                    ${badgeFor(v)}
                </div>

                <div class="ins-ring-wrap">
                    <div class="ins-ring">
                        <svg width="56" height="56" viewBox="0 0 56 56">
                            <circle class="ins-ring-bg" cx="28" cy="28" r="${r}"/>
                            <circle class="ins-ring-fill" cx="28" cy="28" r="${r}"
                                stroke="${color}"
                                stroke-dasharray="${circ}"
                                stroke-dashoffset="${dashOffset}"/>
                        </svg>
                        <div class="ins-ring-text" style="color:${color};">${pct}%</div>
                    </div>
                    <div class="ins-details">
                        <div class="ins-days" style="color:${color};">
                            ${days < 0 ? `Expired ${Math.abs(days)}d ago` : days <= 7 ? `${days}d remaining` : `${days} days left`}
                        </div>
                        <div class="ins-meta">Insurance expires ${fmtDate(v.insurance_expiry)}</div>
                    </div>
                </div>

                <div class="vc-divider"></div>
                <div class="vc-row">
                    <span class="vc-row-label"><i class="ri-user-line"></i> Owner</span>
                    <span class="vc-row-val">${v.owner || v.owner_name || '—'}</span>
                </div>
                <div class="vc-row">
                    <span class="vc-row-label"><i class="ri-map-pin-line"></i> Reg. State</span>
                    <span class="vc-row-val">${(v.id || v.vehicle_number || '').slice(0,2) || '—'}</span>
                </div>

                <div class="vc-actions">
                    <button class="btn-action btn-dispatch" onclick="event.stopPropagation();window.location.href='dispatch.html'">
                        <i class="ri-traffic-light-line"></i> Dispatch
                    </button>
                    <button class="btn-action btn-details" onclick="event.stopPropagation();openDrawer('${v.id}')">
                        <i class="ri-eye-line"></i> Details
                    </button>
                </div>
            </div>
        </div>`;
    }

    /* ── Filter + Render ── */
    function setFilter(f) {
        currentFilter = f;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('filter-' + f).classList.add('active');
        filterCards();
    }

    function filterCards() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        let data = allVehicles;

        if (currentFilter === 'ready')    data = data.filter(v => riskOf(v) === 'safe');
        if (currentFilter === 'expiring') data = data.filter(v => riskOf(v) === 'warn');
        if (currentFilter === 'blocked')  data = data.filter(v => riskOf(v) === 'blocked' || riskOf(v) === 'crit');

        if (q) {
            data = data.filter(v =>
                (v.id||'').toLowerCase().includes(q) ||
                (v.vehicle_number||'').toLowerCase().includes(q) ||
                (v.owner||'').toLowerCase().includes(q) ||
                (v.owner_name||'').toLowerCase().includes(q) ||
                (v.vehicle_type||'').toLowerCase().includes(q) ||
                (v.make||'').toLowerCase().includes(q)
            );
        }

        const grid = document.getElementById('fleetGrid');
        if (!data.length) {
            grid.innerHTML = `<div class="empty-fleet" style="grid-column:1/-1;"><i class="ri-truck-2-line"></i><h3>No vehicles found</h3><p>Try adjusting your filters or search term.</p></div>`;
        } else {
            grid.innerHTML = data.map(buildCard).join('');
        }
    }

    /* ── Load vehicles ── */
    async function loadFleet() {
        try {
            // Load from both tables
            const [vehicles, fleetVehicles] = await Promise.all([
                TruFleet.getVehicles().catch(() => []),
                fetch(((window.location.protocol === 'file:') ? 'http://localhost:3000' : '') + '/api/fleet-vehicles')
                    .then(r => r.json()).catch(() => [])
            ]);

            // Merge, prefer vehicles table
            const all = [...vehicles];
            fleetVehicles.forEach(fv => {
                const exists = all.find(v => v.id === fv.vehicle_number || v.id === fv.vin);
                if (!exists) all.push(fv);
            });

            allVehicles = all;

            // Summary
            const total    = all.length;
            const ready    = all.filter(v => riskOf(v) === 'safe').length;
            const expiring = all.filter(v => riskOf(v) === 'warn').length;
            const blocked  = all.filter(v => riskOf(v) === 'blocked' || riskOf(v) === 'crit').length;

            document.getElementById('sum-total').textContent    = total;
            document.getElementById('sum-active').textContent   = ready;
            document.getElementById('sum-expiring').textContent = expiring;
            document.getElementById('sum-blocked').textContent  = blocked;

            filterCards();

            // GSAP
            gsap.from('.vehicle-card', { y:30, opacity:0, duration:.6, stagger:.05, ease:'power3.out' });

        } catch(e) {
            document.getElementById('fleetGrid').innerHTML = `<div class="empty-fleet" style="grid-column:1/-1;"><i class="ri-error-warning-line"></i><h3>Failed to load fleet</h3><p>${e.message}</p></div>`;
        }
    }

    /* ── Drawer ── */
    function openDrawer(vehicleId) {
        const v = allVehicles.find(x => x.id === vehicleId || x.vehicle_number === vehicleId);
        if (!v) return;
        const risk = riskOf(v);
        const days = TruFleet.daysUntilExpiry(v.insurance_expiry);
        document.getElementById('drawerTitle').textContent = v.id || v.vehicle_number || vehicleId;

        const compChecks = [
            { label: 'Insurance Active', pass: days >= 0, warn: days >= 0 && days <= 7 },
            { label: 'Dispatch Eligible', pass: (v.status||'').toLowerCase() !== 'blocked' && days >= 0 },
            { label: 'Vehicle Active', pass: (v.status||'').toLowerCase() === 'active' },
            { label: 'Commercial Usage', pass: v.vehicle_usage !== 'personal' },
        ];

        document.getElementById('drawerBody').innerHTML = `
            <div class="detail-section">
                <h4>Vehicle Information</h4>
                <div class="detail-grid">
                    <div class="detail-item"><div class="detail-item-label">Registration</div><div class="detail-item-val" style="font-family:'JetBrains Mono',monospace;">${v.id || v.vehicle_number || '—'}</div></div>
                    <div class="detail-item"><div class="detail-item-label">Type</div><div class="detail-item-val">${v.vehicle_type || '—'}</div></div>
                    <div class="detail-item"><div class="detail-item-label">Make / Model</div><div class="detail-item-val">${v.make || '—'} ${v.model || ''}</div></div>
                    <div class="detail-item"><div class="detail-item-label">Year</div><div class="detail-item-val">${v.year || '—'}</div></div>
                    <div class="detail-item"><div class="detail-item-label">Owner</div><div class="detail-item-val">${v.owner || v.owner_name || '—'}</div></div>
                    <div class="detail-item"><div class="detail-item-label">Status</div><div class="detail-item-val">${v.status || '—'}</div></div>
                    <div class="detail-item"><div class="detail-item-label">VIN / Chassis</div><div class="detail-item-val" style="font-family:'JetBrains Mono',monospace;font-size:.8rem;">${v.vin || v.chassis_number || '—'}</div></div>
                    <div class="detail-item"><div class="detail-item-label">Engine No.</div><div class="detail-item-val" style="font-family:'JetBrains Mono',monospace;font-size:.8rem;">${v.engine_number || '—'}</div></div>
                </div>
            </div>

            <div class="detail-section">
                <h4>Insurance</h4>
                <div class="detail-grid">
                    <div class="detail-item"><div class="detail-item-label">Expiry Date</div><div class="detail-item-val" style="color:${risk==='safe'?'#059669':risk==='warn'?'#D97706':'#DC2626'};">${fmtDate(v.insurance_expiry)}</div></div>
                    <div class="detail-item"><div class="detail-item-label">Days Remaining</div><div class="detail-item-val" style="color:${risk==='safe'?'#059669':risk==='warn'?'#D97706':'#DC2626'};">${days < 0 ? `Expired ${Math.abs(days)}d ago` : days + ' days'}</div></div>
                </div>
            </div>

            <div class="detail-section">
                <h4>Compliance Status</h4>
                <div class="compliance-checks">
                    ${compChecks.map(c => `
                        <div class="comp-item ${c.pass && !c.warn ? 'comp-pass' : c.pass && c.warn ? 'comp-warn' : 'comp-fail'}">
                            <i class="${c.pass ? (c.warn ? 'ri-error-warning-line' : 'ri-check-line') : 'ri-close-line'}"></i>
                            ${c.label}
                        </div>
                    `).join('')}
                </div>
            </div>

            <div class="detail-section">
                <h4>Actions</h4>
                <div style="display:flex;gap:.75rem;">
                    <button onclick="window.location.href='dispatch.html'" style="flex:1;padding:.75rem;background:#0F172A;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-family:'Inter';font-size:.875rem;">
                        <i class="ri-traffic-light-line"></i> Request Dispatch
                    </button>
                    <button onclick="window.location.href='insurance_monitor.html'" style="flex:1;padding:.75rem;background:#EFF6FF;color:#2563EB;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-family:'Inter';font-size:.875rem;">
                        <i class="ri-shield-check-line"></i> Update Insurance
                    </button>
                </div>
            </div>
        `;

        document.getElementById('drawerOverlay').classList.add('open');
        document.getElementById('detailDrawer').classList.add('open');
    }

    function closeDrawer() {
        document.getElementById('drawerOverlay').classList.remove('open');
        document.getElementById('detailDrawer').classList.remove('open');
    }

    /* ── Notifications ── */
    async function loadNotifs() {
        const list = document.getElementById('notifList');
        try {
            const data = await TruFleet.getNotifications({ limit: 20 });
            const notifs = data.notifications || [];
            if (!notifs.length) {
                list.innerHTML = '<div style="text-align:center;padding:2rem;color:#94A3B8;">No notifications</div>';
                return;
            }
            list.innerHTML = notifs.map(n => {
                const colors = { critical:'#FEF2F2', high:'#FFFBEB', medium:'#EFF6FF', low:'#F0FDF4' };
                const bg = colors[n.priority] || '#F8FAFC';
                const read = n.read ? 'opacity:.6' : '';
                return `<div style="padding:1rem;border-radius:8px;margin:.25rem;background:${bg};${read};cursor:pointer;" onclick="TruFleet.markNotificationRead('${n.id}');this.style.opacity='.6'">
                    <div style="font-weight:600;font-size:.875rem;">${n.title}</div>
                    <div style="font-size:.8rem;color:#64748B;margin-top:.25rem;">${n.message}</div>
                    <div style="font-size:.75rem;color:#94A3B8;margin-top:.25rem;">${TruFleet.fmtDate(n.created_at)}</div>
                </div>`;
            }).join('');

            const unread = notifs.filter(n => !n.read).length;
            const badge = document.getElementById('notifBadge');
            if (unread > 0) { badge.textContent = unread; badge.style.display = 'flex'; }
            else badge.style.display = 'none';
        } catch(e) {
            list.innerHTML = '<div style="text-align:center;padding:2rem;color:#94A3B8;">Could not load notifications</div>';
        }
    }

    /* ── Boot ── */
    document.addEventListener('DOMContentLoaded', async () => {
        TruFleetRBAC.init('owner');

        const user = TruFleet.getCurrentUser();
        if (user) {
            document.getElementById('ownerGreeting').textContent = `Welcome, ${user.name || 'Fleet Owner'}`;
            document.getElementById('ownerSub').textContent = user.company || 'Your fleet at a glance';
            document.getElementById('userAvatar').textContent = user.initials || 'CO';
        }
        await loadFleet();
        loadNotifs();
    });
</script>
</body>
</html>
